

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=dark>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#274c5e">
  <meta name="author" content="Feng Tao">
  <meta name="keywords" content="">
  
    <meta name="description" content="é¡¹ç›®ï¼šuser_system">
<meta property="og:type" content="article">
<meta property="og:title" content="user_systemé¡¹ç›®">
<meta property="og:url" content="http://example.com/2023/04/18/Go%E9%A1%B9%E7%9B%AE/user-system%E9%A1%B9%E7%9B%AE/index.html">
<meta property="og:site_name" content="èƒ¤å‡¯">
<meta property="og:description" content="é¡¹ç›®ï¼šuser_system">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/user_system.png">
<meta property="article:published_time" content="2023-04-18T06:57:31.000Z">
<meta property="article:modified_time" content="2023-04-21T05:04:40.682Z">
<meta property="article:author" content="Feng Tao">
<meta property="article:tag" content="GO">
<meta property="article:tag" content="é¡¹ç›®">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/images/user_system.png">
  
  
  
  <title>user_systemé¡¹ç›® - èƒ¤å‡¯</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/fluid-extension.css">
<link rel="stylesheet" href="/css/test.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"ğŸ‰","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"n0H6ZjcwsAdPc2zfOJM4bxV4-gzGzoHsz","app_key":"rwjeQIHfYJqQvjh2iWuPkYev","server_url":"https://n0h6zjcw.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":true}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>èƒ¤å‡¯</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>é¦–é¡µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>å½’æ¡£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>åˆ†ç±»</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>æ ‡ç­¾</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>å…³äº</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/none.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="user_systemé¡¹ç›®"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-04-18 14:57" pubdate>
          2023å¹´4æœˆ18æ—¥ ä¸‹åˆ
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          59k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          489 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> æ¬¡
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">user_systemé¡¹ç›®</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="é¡¹ç›®ï¼šuser-system"><a href="#é¡¹ç›®ï¼šuser-system" class="headerlink" title="é¡¹ç›®ï¼šuser_system"></a>é¡¹ç›®ï¼šuser_system<span id="more"></span></h1><p><strong>ä¸‹é¢æ˜¯å¯¹äºå„ä¸ªç›®å½•ä¸‹çš„å„ä¸ªæ–‡ä»¶çš„å‡½æ•°çš„è®²è§£ã€‚</strong></p>
<h2 id="1ã€configåŒ…"><a href="#1ã€configåŒ…" class="headerlink" title="1ã€configåŒ…"></a>1ã€configåŒ…</h2><h3 id="ï¼ˆ1ï¼‰config-go"><a href="#ï¼ˆ1ï¼‰config-go" class="headerlink" title="ï¼ˆ1ï¼‰config.go"></a>ï¼ˆ1ï¼‰config.go</h3><p>â€‹	è¿™æ˜¯ä¸€ä¸ª Go è¯­è¨€çš„é…ç½®åŒ…ï¼Œç”¨äºè¯»å–å¹¶è§£æé…ç½®æ–‡ä»¶ã€‚è¯¥åŒ…ä½¿ç”¨äº† viper åº“ï¼Œå¯ä»¥è¯»å– YAML æ ¼å¼çš„é…ç½®æ–‡ä»¶ã€‚å…¶ä¸­å®šä¹‰äº†ä¸€äº›ç»“æ„ä½“ï¼Œåˆ†åˆ«å¯¹åº”äº†ä¸åŒçš„é…ç½®é¡¹ï¼Œä¾‹å¦‚æ—¥å¿—é…ç½®ã€æ•°æ®åº“é…ç½®ã€Redis é…ç½®ç­‰ç­‰ã€‚ä½¿ç”¨è€…å¯ä»¥é€šè¿‡è°ƒç”¨ <code>GetGlobalConf()</code> å‡½æ•°è·å–å…¨å±€é…ç½®æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨ <code>InitConfig()</code> å‡½æ•°æ¥åˆå§‹åŒ–æ—¥å¿—ã€‚åœ¨ <code>InitConfig()</code> å‡½æ•°ä¸­ï¼Œä¼šå…ˆè·å–å…¨å±€é…ç½®æ–‡ä»¶ï¼Œç„¶åæ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„æ—¥å¿—çº§åˆ«å’Œè¾“å‡ºæ–¹å¼ç­‰å‚æ•°è¿›è¡Œåˆå§‹åŒ–ï¼ŒåŒæ—¶è®¾ç½®æ—¥å¿—æ ¼å¼ä¸º JSON æ ¼å¼ï¼Œå¹¶ä¸”æ‰“å°æ–‡ä»¶ä½ç½®å’Œè¡Œå·ç­‰ä¿¡æ¯ã€‚æœ€åæ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„è¾“å‡ºæ–¹å¼ï¼Œå°†æ—¥å¿—è¾“å‡ºåˆ°ç»ˆç«¯æˆ–è€…æ–‡ä»¶ä¸­ã€‚</p>
<h4 id="å…¨å±€é…ç½®"><a href="#å…¨å±€é…ç½®" class="headerlink" title="å…¨å±€é…ç½®"></a>å…¨å±€é…ç½®</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> (<br>   config GlobalConfig <span class="hljs-comment">// å…¨å±€ä¸šåŠ¡é…ç½®æ–‡ä»¶</span><br>   once   sync.Once<br>)<br></code></pre></td></tr></table></figure>

<p>â€‹	é…ç½®å…¨å±€ä¸šåŠ¡é…ç½®æ–‡ä»¶ï¼Œä¾¿äºæ–‡ä»¶å†…çš„ä½¿ç”¨ã€‚</p>
<hr>
<h4 id="LogConfç±»å‹æ—¥å¿—é…ç½®"><a href="#LogConfç±»å‹æ—¥å¿—é…ç½®" class="headerlink" title="LogConfç±»å‹	æ—¥å¿—é…ç½®"></a>LogConfç±»å‹	æ—¥å¿—é…ç½®</h4><p>â€‹	<strong>æ—¥å¿—è¾“å‡ºçš„ç›¸å…³é…ç½®ä¿¡æ¯</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//LogConf æ—¥å¿—é…ç½®</span><br><span class="hljs-keyword">type</span> LogConf <span class="hljs-keyword">struct</span> &#123;<br>	LogPattern <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;log_pattern&quot; mapstructure:&quot;log_pattern&quot;`</span> <span class="hljs-comment">// æ—¥å¿—è¾“å‡ºæ ‡å‡†ï¼Œç»ˆç«¯è¾“å‡º/æ–‡ä»¶è¾“å‡º</span><br>	LogPath    <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;log_path&quot; mapstructure:&quot;log_path&quot;`</span>       <span class="hljs-comment">// è¡¨ç¤ºæ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶æ—¶çš„è·¯å¾„ã€‚</span><br>	SaveDays   <span class="hljs-type">uint</span>   <span class="hljs-string">`yaml:&quot;save_days&quot; mapstructure:&quot;save_days&quot;`</span>     <span class="hljs-comment">// è¡¨ç¤ºæ—¥å¿—ä¿å­˜çš„å¤©æ•°ï¼Œè¿‡æœŸçš„æ—¥å¿—æ–‡ä»¶å°†è¢«åˆ é™¤ã€‚</span><br>	Level      <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;level&quot; mapstructure:&quot;level&quot;`</span>             <span class="hljs-comment">// è¡¨ç¤ºæ—¥å¿—è¾“å‡ºçš„çº§åˆ«ï¼ŒåŒ…æ‹¬ DEBUGã€INFOã€WARNã€ERRORã€FATAL ç­‰çº§åˆ«ï¼Œçº§åˆ«ä»ä½åˆ°é«˜ä¾æ¬¡å¢å¼ºã€‚</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	ç»“æ„ä½“ä¸­çš„ <code>yaml</code> å’Œ <code>mapstructure</code> æ ‡ç­¾æ˜¯ç”¨äºæŒ‡å®šå°†ç»“æ„ä½“åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¸ºYAMLå’ŒMapç±»å‹æ—¶ï¼Œå¦‚ä½•å°†ç»“æ„ä½“å­—æ®µæ˜ å°„åˆ°YAMLæˆ–Mapä¸­çš„é”®åã€‚</p>
<p>â€‹	å…·ä½“æ¥è¯´ï¼Œ<code>yaml:&quot;log_pattern&quot;</code> è¡¨ç¤ºåœ¨åºåˆ—åŒ–ä¸ºYAMLæ ¼å¼æ—¶ï¼Œ<code>LogPattern</code> å­—æ®µå°†è¢«æ˜ å°„åˆ°é”®åä¸º <code>log_pattern</code> çš„YAMLé”®ï¼›<code>mapstructure:&quot;log_pattern&quot;</code> åˆ™è¡¨ç¤ºåœ¨ååºåˆ—åŒ–æ—¶ï¼ŒYAMLä¸­çš„ <code>log_pattern</code> é”®å°†è¢«æ˜ å°„åˆ° <code>LogPattern</code> å­—æ®µã€‚</p>
<p>â€‹	ç±»ä¼¼çš„ï¼Œ<code>yaml:&quot;log_path&quot;</code> å’Œ <code>mapstructure:&quot;log_path&quot;</code> è¡¨ç¤º <code>LogPath</code> å­—æ®µçš„æ˜ å°„å…³ç³»ï¼›<code>yaml:&quot;save_days&quot;</code> å’Œ <code>mapstructure:&quot;save_days&quot;</code> è¡¨ç¤º <code>SaveDays</code> å­—æ®µçš„æ˜ å°„å…³ç³»ï¼›<code>yaml:&quot;level&quot;</code> å’Œ <code>mapstructure:&quot;level&quot;</code> è¡¨ç¤º <code>Level</code> å­—æ®µçš„æ˜ å°„å…³ç³»ã€‚è¿™äº›æ ‡ç­¾çš„ä½¿ç”¨ä½¿å¾—åœ¨ä¸åŒçš„æ ¼å¼ä¸­è¯»å–å’Œå†™å…¥é…ç½®å˜å¾—æ›´åŠ æ–¹ä¾¿ã€‚</p>
<hr>
<h4 id="DbConfç±»å‹dbé…ç½®ç»“æ„"><a href="#DbConfç±»å‹dbé…ç½®ç»“æ„" class="headerlink" title="DbConfç±»å‹	dbé…ç½®ç»“æ„"></a>DbConfç±»å‹	dbé…ç½®ç»“æ„</h4><p>â€‹	<strong>æ•°æ®åº“è¿æ¥çš„ç›¸å…³é…ç½®ä¿¡æ¯</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> DbConf <span class="hljs-keyword">struct</span> &#123;<br>	Host        <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;host&quot; mapstructure:&quot;host&quot;`</span>                   <span class="hljs-comment">// dbä¸»æœºåœ°å€</span><br>	Port        <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;port&quot; mapstructure:&quot;port&quot;`</span>                   <span class="hljs-comment">// dbç«¯å£</span><br>	User        <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;user&quot; mapstructure:&quot;user&quot;`</span>                   <span class="hljs-comment">// ç”¨æˆ·å</span><br>	Password    <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;password&quot; mapstructure:&quot;password&quot;`</span>           <span class="hljs-comment">// å¯†ç </span><br>	Dbname      <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;dbname&quot; mapstructure:&quot;dbname&quot;`</span>               <span class="hljs-comment">// dbå</span><br>	MaxIdleConn <span class="hljs-type">int</span>    <span class="hljs-string">`yaml:&quot;max_idle_conn&quot; mapstructure:&quot;max_idle_conn&quot;`</span> <span class="hljs-comment">// æœ€å¤§ç©ºé—²è¿æ¥æ•°</span><br>	MaxOpenConn <span class="hljs-type">int</span>    <span class="hljs-string">`yaml:&quot;max_open_conn&quot; mapstructure:&quot;max_open_conn&quot;`</span> <span class="hljs-comment">// æœ€å¤§æ‰“å¼€çš„è¿æ¥æ•°</span><br>	MaxIdleTime <span class="hljs-type">int64</span>  <span class="hljs-string">`yaml:&quot;max_idle_time&quot; mapstructure:&quot;max_idle_time&quot;`</span> <span class="hljs-comment">// è¿æ¥æœ€å¤§ç©ºé—²æ—¶é—´</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç»“æ„ä½“ä¸­çš„ <code>yaml</code> å’Œ <code>mapstructure</code> æ ‡ç­¾ä½œç”¨å¦‚ä¸Šæ‰€è¿°ï¼Œåœ¨åç»­ä¸­ä¹Ÿä¸å†èµ˜è¿°ã€‚</p>
<hr>
<h4 id="AppConfç±»å‹æœåŠ¡é…ç½®"><a href="#AppConfç±»å‹æœåŠ¡é…ç½®" class="headerlink" title="AppConfç±»å‹	æœåŠ¡é…ç½®"></a>AppConfç±»å‹	æœåŠ¡é…ç½®</h4><p>â€‹	<strong>æè¿°åº”ç”¨ç¨‹åºçš„åŸºæœ¬é…ç½®ä¿¡æ¯</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> AppConf <span class="hljs-keyword">struct</span> &#123;<br>	AppName <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;app_name&quot; mapstructure:&quot;app_name&quot;`</span> <span class="hljs-comment">// ä¸šåŠ¡å</span><br>	Version <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;version&quot; mapstructure:&quot;version&quot;`</span>   <span class="hljs-comment">// ç‰ˆæœ¬</span><br>	Port    <span class="hljs-type">int</span>    <span class="hljs-string">`yaml:&quot;port&quot; mapstructure:&quot;port&quot;`</span>         <span class="hljs-comment">// ç«¯å£</span><br>	RunMode <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;run_mode&quot; mapstructure:&quot;run_mode&quot;`</span> <span class="hljs-comment">// è¿è¡Œæ¨¡å¼</span><br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="RedisConfç±»å‹é…ç½®"><a href="#RedisConfç±»å‹é…ç½®" class="headerlink" title="RedisConfç±»å‹	é…ç½®"></a>RedisConfç±»å‹	é…ç½®</h4><p>â€‹	<strong>æè¿° Redis æ•°æ®åº“çš„é…ç½®ä¿¡æ¯</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> RedisConf <span class="hljs-keyword">struct</span> &#123;<br>	Host     <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;rhost&quot; mapstructure:&quot;rhost&quot;`</span> <span class="hljs-comment">// dbä¸»æœºåœ°å€</span><br>	Port     <span class="hljs-type">int</span>    <span class="hljs-string">`yaml:&quot;rport&quot; mapstructure:&quot;rport&quot;`</span> <span class="hljs-comment">// dbç«¯å£</span><br>	DB       <span class="hljs-type">int</span>    <span class="hljs-string">`yaml:&quot;rdb&quot; mapstructure:&quot;rdb&quot;`</span> <span class="hljs-comment">//è¡¨ç¤º Redis æœåŠ¡å™¨ä¸Šçš„å“ªä¸ªæ•°æ®åº“ï¼Œä»0åˆ°15å…±16ä¸ªæ•°æ®åº“ã€‚</span><br>	PassWord <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;passwd&quot; mapstructure:&quot;passwd&quot;`</span> <span class="hljs-comment">//è¡¨ç¤ºè¿æ¥ Redis æœåŠ¡å™¨æ‰€éœ€çš„å¯†ç ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®å¯†ç åˆ™è¯¥å­—æ®µä¸ºç©ºå­—ç¬¦ä¸²ã€‚</span><br>	PoolSize <span class="hljs-type">int</span>    <span class="hljs-string">`yaml:&quot;poolsize&quot; mapstructure:&quot;poolsize&quot;`</span>	<span class="hljs-comment">//è¿æ¥æ± çš„å¤§å°ï¼Œå³æœ€å¤§è¿æ¥æ•°ã€‚</span><br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="Cacheç±»å‹ç¼“å­˜"><a href="#Cacheç±»å‹ç¼“å­˜" class="headerlink" title="Cacheç±»å‹	ç¼“å­˜"></a>Cacheç±»å‹	ç¼“å­˜</h4><p>â€‹	<strong>å®šä¹‰äº†ç¼“å­˜ç›¸å…³çš„é…ç½®ä¿¡æ¯</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Cache <span class="hljs-keyword">struct</span> &#123;<br>	SessionExpired <span class="hljs-type">int</span> <span class="hljs-string">`yaml:&quot;session_expired&quot; mapstructure:&quot;session_expired&quot;`</span> <span class="hljs-comment">//è¡¨ç¤ºä¼šè¯è¿‡æœŸæ—¶é—´</span><br>	UserExpired    <span class="hljs-type">int</span> <span class="hljs-string">`yaml:&quot;user_expired&quot; mapstructure:&quot;user_expired&quot;`</span>       <span class="hljs-comment">//è¡¨ç¤ºç”¨æˆ·ä¿¡æ¯è¿‡æœŸæ—¶é—´</span><br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="GlobalConfigå‡½æ•°ä¸šåŠ¡é…ç½®ç»“æ„ä½“"><a href="#GlobalConfigå‡½æ•°ä¸šåŠ¡é…ç½®ç»“æ„ä½“" class="headerlink" title="GlobalConfigå‡½æ•°	ä¸šåŠ¡é…ç½®ç»“æ„ä½“"></a>GlobalConfigå‡½æ•°	ä¸šåŠ¡é…ç½®ç»“æ„ä½“</h4><p>â€‹	<strong>æ ¹æ®åµŒå¥—è‡ªå®šä¹‰çš„ç»“æ„ä½“ä¸šåŠ¡é…ç½®ç»“æ„ä½“</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> GlobalConfig <span class="hljs-keyword">struct</span> &#123;<br>	AppConfig   AppConf   <span class="hljs-string">`yaml:&quot;app&quot; mapstructure:&quot;app&quot;`</span><br>	CorsOrigin  []<span class="hljs-type">string</span>  <span class="hljs-string">`yaml:&quot;cors_origin&quot; mapstructure:&quot;cors_origin&quot;`</span> <span class="hljs-comment">// è·¨åŸŸæºåˆ—è¡¨</span><br>	DbConfig    DbConf    <span class="hljs-string">`yaml:&quot;db&quot; mapstructure:&quot;db&quot;`</span>                   <span class="hljs-comment">// dbé…ç½®</span><br>	LogConfig   LogConf   <span class="hljs-string">`yaml:&quot;log&quot; mapstructure:&quot;log&quot;`</span>                 <span class="hljs-comment">// æ—¥å¿—é…ç½®</span><br>	RedisConfig RedisConf <span class="hljs-string">`yaml:&quot;redis&quot; mapstructure:&quot;redis&quot;`</span>             <span class="hljs-comment">// redisé…ç½®</span><br>	Cache       Cache     <span class="hljs-string">`yaml:&quot;cache&quot; mapstructure:&quot;cache&quot;`</span>             <span class="hljs-comment">// cacheé…ç½®</span><br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="readConfå‡½æ•°è¯»å–åº”ç”¨ç¨‹åºé…ç½®æ–‡ä»¶"><a href="#readConfå‡½æ•°è¯»å–åº”ç”¨ç¨‹åºé…ç½®æ–‡ä»¶" class="headerlink" title="readConfå‡½æ•°	è¯»å–åº”ç”¨ç¨‹åºé…ç½®æ–‡ä»¶"></a>readConfå‡½æ•°	è¯»å–åº”ç”¨ç¨‹åºé…ç½®æ–‡ä»¶</h4><p>â€‹	<strong>ä½¿ç”¨ viper åº“è¯»å– YAML æ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼Œå¹¶å°†é…ç½®ä¿¡æ¯è§£æåˆ° <code>config</code> å˜é‡ä¸­ã€‚</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">readConf</span><span class="hljs-params">()</span></span> &#123;<br>	viper.SetConfigName(<span class="hljs-string">&quot;app&quot;</span>)<br>	viper.SetConfigType(<span class="hljs-string">&quot;yml&quot;</span>)<br>	viper.AddConfigPath(<span class="hljs-string">&quot;.&quot;</span>)<br>	viper.AddConfigPath(<span class="hljs-string">&quot;./conf&quot;</span>)<br>	viper.AddConfigPath(<span class="hljs-string">&quot;../conf&quot;</span>)<br>	err := viper.ReadInConfig()<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;read config file err:&quot;</span> + err.Error())<br>	&#125;<br>	err = viper.Unmarshal(&amp;config)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;config file unmarshal err:&quot;</span> + err.Error())<br>	&#125;<br>	log.Infof(<span class="hljs-string">&quot;config === %+v&quot;</span>, config)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	åœ¨å‡½æ•°å†…éƒ¨ï¼Œé¦–å…ˆé€šè¿‡ <code>viper.SetConfigName()</code>ã€<code>viper.SetConfigType()</code> å’Œ <code>viper.AddConfigPath()</code> å‡½æ•°æŒ‡å®šäº†é…ç½®æ–‡ä»¶çš„åç§°ã€ç±»å‹å’Œè·¯å¾„ï¼Œç„¶åé€šè¿‡ <code>viper.ReadInConfig()</code> å‡½æ•°è¯»å–é…ç½®æ–‡ä»¶ã€‚</p>
<p>â€‹	è¯»å–é…ç½®æ–‡ä»¶åï¼Œä½¿ç”¨ <code>viper.Unmarshal()</code> å‡½æ•°å°†é…ç½®ä¿¡æ¯è§£æåˆ° <code>config</code> å˜é‡ä¸­ï¼Œè§£æè¿‡ç¨‹ä¸­ä¼šæŒ‰ç…§ç»“æ„ä½“æˆå‘˜çš„æ ‡ç­¾ä¿¡æ¯æ¥è¯»å–é…ç½®é¡¹çš„å€¼ã€‚</p>
<p>â€‹	æœ€åï¼Œåœ¨è§£æå®Œæˆåï¼Œä½¿ç”¨æ—¥å¿—åº“æ‰“å°å‡ºè¯»å–åˆ°çš„é…ç½®ä¿¡æ¯ï¼Œå¹¶å°† <code>config</code> å˜é‡ä¿å­˜åœ¨å…¨å±€å˜é‡ä¸­ä¾›åç»­ä½¿ç”¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸ºäº†ä¿è¯å…¨å±€å˜é‡åªè¢«åˆå§‹åŒ–ä¸€æ¬¡ï¼Œè¿™é‡Œä½¿ç”¨äº† <code>sync.Once</code> æ¥å®ç°æ‡’æ±‰å¼å•ä¾‹æ¨¡å¼ã€‚</p>
<hr>
<h4 id="GetGlobalConfå‡½æ•°è·å–å…¨å±€é…ç½®æ–‡ä»¶"><a href="#GetGlobalConfå‡½æ•°è·å–å…¨å±€é…ç½®æ–‡ä»¶" class="headerlink" title="GetGlobalConfå‡½æ•°	è·å–å…¨å±€é…ç½®æ–‡ä»¶"></a>GetGlobalConfå‡½æ•°	è·å–å…¨å±€é…ç½®æ–‡ä»¶</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetGlobalConf</span><span class="hljs-params">()</span></span> *GlobalConfig &#123;<br>	once.Do(readConf)<br>	<span class="hljs-keyword">return</span> &amp;config<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¿™æ®µä»£ç å®šä¹‰äº†ä¸€ä¸ªå‡½æ•° <code>GetGlobalConf()</code>ï¼Œå®ƒè¿”å›ä¸€ä¸ªæŒ‡å‘ <code>GlobalConfig</code> ç»“æ„ä½“çš„æŒ‡é’ˆã€‚è¯¥å‡½æ•°ä½¿ç”¨äº† <code>sync.Once</code> ç±»å‹çš„å˜é‡ <code>once</code>ï¼Œä»¥ç¡®ä¿ <code>readConf()</code> å‡½æ•°åªè¢«è°ƒç”¨ä¸€æ¬¡æ¥è¯»å–é…ç½®æ–‡ä»¶ï¼Œå¹¶å°†è§£æçš„ç»“æœå­˜å‚¨åœ¨ <code>config</code> å˜é‡ä¸­ã€‚ <code>readConf()</code> å‡½æ•°è´Ÿè´£ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–é…ç½®ä¿¡æ¯ï¼Œå¹¶ä½¿ç”¨ <code>viper</code> åº“è§£æ YAML æ ¼å¼çš„é…ç½®æ–‡ä»¶ã€‚</p>
<hr>
<h4 id="InitConfigå‡½æ•°åˆå§‹åŒ–æ—¥å¿—"><a href="#InitConfigå‡½æ•°åˆå§‹åŒ–æ—¥å¿—" class="headerlink" title="InitConfigå‡½æ•°	åˆå§‹åŒ–æ—¥å¿—"></a>InitConfigå‡½æ•°	åˆå§‹åŒ–æ—¥å¿—</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitConfig</span><span class="hljs-params">()</span></span> &#123;<br>	globalConf := GetGlobalConf() <span class="hljs-comment">//è·å–å…¨å±€é…ç½®æ–‡ä»¶</span><br>	<span class="hljs-comment">// è®¾ç½®æ—¥å¿—çº§åˆ«</span><br>	level, err := log.ParseLevel(globalConf.LogConfig.Level)	<span class="hljs-comment">//å®ç°å­—ç¬¦ä¸²åˆ°log.Levelç±»å‹çš„è½¬æ¢</span><br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;log level parse err:&quot;</span> + err.Error())<br>	&#125;<br>	<span class="hljs-comment">// è®¾ç½®æ—¥å¿—æ ¼å¼ä¸ºjsonæ ¼å¼</span><br>	log.SetFormatter(&amp;logFormatter&#123;<br>		log.TextFormatter&#123;<br>			DisableColors:   <span class="hljs-literal">true</span>,<br>			TimestampFormat: <span class="hljs-string">&quot;2006-01-02 15:04:05&quot;</span>,<br>			FullTimestamp:   <span class="hljs-literal">true</span>,<br>		&#125;&#125;)<br>	log.SetReportCaller(<span class="hljs-literal">true</span>) <span class="hljs-comment">// æ‰“å°æ–‡ä»¶ä½ç½®ï¼Œè¡Œå·</span><br>	log.SetLevel(level)       <span class="hljs-comment">//è®¾ç½®æ—¥å¿—çš„è®°å½•çº§åˆ«</span><br>	<span class="hljs-keyword">switch</span> globalConf.LogConfig.LogPattern &#123;<br>	<span class="hljs-keyword">case</span> <span class="hljs-string">&quot;stdout&quot;</span>:<br>		log.SetOutput(os.Stdout)<br>	<span class="hljs-keyword">case</span> <span class="hljs-string">&quot;stderr&quot;</span>:<br>		log.SetOutput(os.Stderr)<br>	<span class="hljs-keyword">case</span> <span class="hljs-string">&quot;file&quot;</span>:<br>		logger, err := rlog.New(<br>			globalConf.LogConfig.LogPath+<span class="hljs-string">&quot;.%Y%m%d&quot;</span>,<br>			<span class="hljs-comment">//rlog.WithLinkName(globalConf.LogConf.LogPath),</span><br>			rlog.WithRotationCount(globalConf.LogConfig.SaveDays),<br>			<span class="hljs-comment">//rlog.WithMaxAge(time.Minute*3),</span><br>			rlog.WithRotationTime(time.Hour*<span class="hljs-number">24</span>),<br>		)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;log conf err: &quot;</span> + err.Error())<br>		&#125;<br>		log.SetOutput(logger)<br>	<span class="hljs-keyword">default</span>:<br>		<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;log conf err, check log_pattern in logsvr.yaml&quot;</span>)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	é¦–å…ˆï¼Œå®ƒè°ƒç”¨<code>GetGlobalConf()</code>å‡½æ•°è·å–å…¨å±€é…ç½®ï¼›æ¥ç€ï¼Œæ ¹æ®é…ç½®è®¾ç½®æ—¥å¿—çº§åˆ«ã€æ ¼å¼å’Œè¾“å‡ºæ–¹å¼ã€‚</p>
<p>â€‹	å…¨å±€é…ç½®æ–‡ä»¶ä¸­çš„æ—¥å¿—çº§åˆ«æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œéœ€è¦è½¬æ¢ä¸ºlogrusåŒ…ä¸­çš„log.Levelç±»å‹ï¼Œä»¥ä¾¿äºåç»­æ—¥å¿—è®°å½•å’Œè¾“å‡ºã€‚è¿™é‡Œä½¿ç”¨äº†logrusåŒ…ä¸­çš„ParseLevelå‡½æ•°æ¥å®ç°å­—ç¬¦ä¸²åˆ°log.Levelç±»å‹çš„è½¬æ¢ã€‚å¦‚æœè§£æå¤±è´¥ï¼Œerrä¸ä¸ºnilï¼Œå¦åˆ™levelå˜é‡å­˜å‚¨è§£æå¾—åˆ°çš„æ—¥å¿—çº§åˆ«ã€‚</p>
<p><code>log.SetOutput</code>ï¼šæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒè®¾ç½®loggerè¾“å‡ºçš„ç›®çš„åœ°ã€‚å®ƒéœ€è¦ä¸€ä¸ªio.Writerç±»å‹çš„å‚æ•°ï¼Œé€šå¸¸ä¼šä¼ å…¥os.Stdoutï¼ˆæ ‡å‡†è¾“å‡ºï¼‰æˆ–os.Stderrï¼ˆæ ‡å‡†é”™è¯¯è¾“å‡ºï¼‰æ¥æ§åˆ¶æ—¥å¿—ä¿¡æ¯çš„è¾“å‡ºä½ç½®ã€‚</p>
<p>â€‹	æœ€åï¼Œæ ¹æ®å…¨å±€é…ç½®ä¸­çš„æ—¥å¿—è¾“å‡ºæ ‡å‡†<code>globalConf.LogConfig.LogPattern</code>æ¥è®¾ç½®æ—¥å¿—è¾“å‡ºä½ç½®ï¼Œå¯ä»¥æ˜¯æ ‡å‡†è¾“å‡º<code>stdout</code>ã€æ ‡å‡†é”™è¯¯è¾“å‡º<code>stderr</code>æˆ–æ–‡ä»¶è¾“å‡º<code>file</code>ï¼Œæ–‡ä»¶è¾“å‡ºéœ€è¦æŒ‡å®šæ–‡ä»¶è·¯å¾„å’Œæ—¥å¿—ä¿ç•™æ—¶é—´ã€‚å¦‚æœæ—¥å¿—è¾“å‡ºæ ‡å‡†ä¸åˆæ³•ï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<h4 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> config<br><br><span class="hljs-keyword">import</span> (<br>	rlog <span class="hljs-string">&quot;github.com/lestrrat-go/file-rotatelogs&quot;</span><br>	log <span class="hljs-string">&quot;github.com/sirupsen/logrus&quot;</span><br>	<span class="hljs-string">&quot;os&quot;</span><br>	<span class="hljs-string">&quot;sync&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br><br>	<span class="hljs-string">&quot;github.com/spf13/viper&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> (<br>	config GlobalConfig <span class="hljs-comment">// å…¨å±€ä¸šåŠ¡é…ç½®æ–‡ä»¶</span><br>	once   sync.Once<br>)<br><br><span class="hljs-comment">// LogConf æ—¥å¿—é…ç½®</span><br><span class="hljs-keyword">type</span> LogConf <span class="hljs-keyword">struct</span> &#123;<br>	LogPattern <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;log_pattern&quot; mapstructure:&quot;log_pattern&quot;`</span> <span class="hljs-comment">// æ—¥å¿—è¾“å‡ºæ ‡å‡†ï¼Œç»ˆç«¯è¾“å‡º/æ–‡ä»¶è¾“å‡º</span><br>	LogPath    <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;log_path&quot; mapstructure:&quot;log_path&quot;`</span>       <span class="hljs-comment">// æ—¥å¿—è·¯å¾„</span><br>	SaveDays   <span class="hljs-type">uint</span>   <span class="hljs-string">`yaml:&quot;save_days&quot; mapstructure:&quot;save_days&quot;`</span>     <span class="hljs-comment">// æ—¥å¿—ä¿å­˜å¤©æ•°</span><br>	Level      <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;level&quot; mapstructure:&quot;level&quot;`</span>             <span class="hljs-comment">// æ—¥å¿—çº§åˆ«</span><br>&#125;<br><br><span class="hljs-comment">// DbConf dbé…ç½®ç»“æ„</span><br><span class="hljs-keyword">type</span> DbConf <span class="hljs-keyword">struct</span> &#123;<br>	Host        <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;host&quot; mapstructure:&quot;host&quot;`</span>                   <span class="hljs-comment">// dbä¸»æœºåœ°å€</span><br>	Port        <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;port&quot; mapstructure:&quot;port&quot;`</span>                   <span class="hljs-comment">// dbç«¯å£</span><br>	User        <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;user&quot; mapstructure:&quot;user&quot;`</span>                   <span class="hljs-comment">// ç”¨æˆ·å</span><br>	Password    <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;password&quot; mapstructure:&quot;password&quot;`</span>           <span class="hljs-comment">// å¯†ç </span><br>	Dbname      <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;dbname&quot; mapstructure:&quot;dbname&quot;`</span>               <span class="hljs-comment">// dbå</span><br>	MaxIdleConn <span class="hljs-type">int</span>    <span class="hljs-string">`yaml:&quot;max_idle_conn&quot; mapstructure:&quot;max_idle_conn&quot;`</span> <span class="hljs-comment">// æœ€å¤§ç©ºé—²è¿æ¥æ•°</span><br>	MaxOpenConn <span class="hljs-type">int</span>    <span class="hljs-string">`yaml:&quot;max_open_conn&quot; mapstructure:&quot;max_open_conn&quot;`</span> <span class="hljs-comment">// æœ€å¤§æ‰“å¼€çš„è¿æ¥æ•°</span><br>	MaxIdleTime <span class="hljs-type">int64</span>  <span class="hljs-string">`yaml:&quot;max_idle_time&quot; mapstructure:&quot;max_idle_time&quot;`</span> <span class="hljs-comment">// è¿æ¥æœ€å¤§ç©ºé—²æ—¶é—´</span><br>&#125;<br><br><span class="hljs-comment">// AppConf æœåŠ¡é…ç½®</span><br><span class="hljs-keyword">type</span> AppConf <span class="hljs-keyword">struct</span> &#123;<br>	AppName <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;app_name&quot; mapstructure:&quot;app_name&quot;`</span> <span class="hljs-comment">// ä¸šåŠ¡å</span><br>	Version <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;version&quot; mapstructure:&quot;version&quot;`</span>   <span class="hljs-comment">// ç‰ˆæœ¬</span><br>	Port    <span class="hljs-type">int</span>    <span class="hljs-string">`yaml:&quot;port&quot; mapstructure:&quot;port&quot;`</span>         <span class="hljs-comment">// ç«¯å£</span><br>	RunMode <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;run_mode&quot; mapstructure:&quot;run_mode&quot;`</span> <span class="hljs-comment">// è¿è¡Œæ¨¡å¼</span><br>&#125;<br><br><span class="hljs-comment">// RedisConf é…ç½®</span><br><span class="hljs-keyword">type</span> RedisConf <span class="hljs-keyword">struct</span> &#123;<br>	Host     <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;rhost&quot; mapstructure:&quot;rhost&quot;`</span>       <span class="hljs-comment">// dbä¸»æœºåœ°å€</span><br>	Port     <span class="hljs-type">int</span>    <span class="hljs-string">`yaml:&quot;rport&quot; mapstructure:&quot;rport&quot;`</span>       <span class="hljs-comment">// dbç«¯å£</span><br>	DB       <span class="hljs-type">int</span>    <span class="hljs-string">`yaml:&quot;rdb&quot; mapstructure:&quot;rdb&quot;`</span>           <span class="hljs-comment">//è¡¨ç¤º Redis æœåŠ¡å™¨ä¸Šçš„å“ªä¸ªæ•°æ®åº“ï¼Œä»0åˆ°15å…±16ä¸ªæ•°æ®åº“ã€‚</span><br>	PassWord <span class="hljs-type">string</span> <span class="hljs-string">`yaml:&quot;passwd&quot; mapstructure:&quot;passwd&quot;`</span>     <span class="hljs-comment">//è¡¨ç¤ºè¿æ¥ Redis æœåŠ¡å™¨æ‰€éœ€çš„å¯†ç ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®å¯†ç åˆ™è¯¥å­—æ®µä¸ºç©ºå­—ç¬¦ä¸²ã€‚</span><br>	PoolSize <span class="hljs-type">int</span>    <span class="hljs-string">`yaml:&quot;poolsize&quot; mapstructure:&quot;poolsize&quot;`</span> <span class="hljs-comment">//è¿æ¥æ± çš„å¤§å°ï¼Œå³æœ€å¤§è¿æ¥æ•°ã€‚</span><br>&#125;<br><br><span class="hljs-keyword">type</span> Cache <span class="hljs-keyword">struct</span> &#123;<br>	SessionExpired <span class="hljs-type">int</span> <span class="hljs-string">`yaml:&quot;session_expired&quot; mapstructure:&quot;session_expired&quot;`</span> <span class="hljs-comment">//è¡¨ç¤ºä¼šè¯è¿‡æœŸæ—¶é—´</span><br>	UserExpired    <span class="hljs-type">int</span> <span class="hljs-string">`yaml:&quot;user_expired&quot; mapstructure:&quot;user_expired&quot;`</span>       <span class="hljs-comment">//è¡¨ç¤ºç”¨æˆ·ä¿¡æ¯è¿‡æœŸæ—¶é—´</span><br>&#125;<br><br><span class="hljs-comment">// GlobalConfig ä¸šåŠ¡é…ç½®ç»“æ„ä½“</span><br><span class="hljs-keyword">type</span> GlobalConfig <span class="hljs-keyword">struct</span> &#123;<br>	AppConfig   AppConf   <span class="hljs-string">`yaml:&quot;app&quot; mapstructure:&quot;app&quot;`</span><br>	CorsOrigin  []<span class="hljs-type">string</span>  <span class="hljs-string">`yaml:&quot;cors_origin&quot; mapstructure:&quot;cors_origin&quot;`</span> <span class="hljs-comment">// è·¨åŸŸæºåˆ—è¡¨</span><br>	DbConfig    DbConf    <span class="hljs-string">`yaml:&quot;db&quot; mapstructure:&quot;db&quot;`</span>                   <span class="hljs-comment">// dbé…ç½®</span><br>	LogConfig   LogConf   <span class="hljs-string">`yaml:&quot;log&quot; mapstructure:&quot;log&quot;`</span>                 <span class="hljs-comment">// æ—¥å¿—é…ç½®</span><br>	RedisConfig RedisConf <span class="hljs-string">`yaml:&quot;redis&quot; mapstructure:&quot;redis&quot;`</span>             <span class="hljs-comment">// redisé…ç½®</span><br>	Cache       Cache     <span class="hljs-string">`yaml:&quot;cache&quot; mapstructure:&quot;cache&quot;`</span>             <span class="hljs-comment">// cacheé…ç½®</span><br>&#125;<br><br><span class="hljs-comment">// GetGlobalConf è·å–å…¨å±€é…ç½®æ–‡ä»¶</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetGlobalConf</span><span class="hljs-params">()</span></span> *GlobalConfig &#123;<br>	once.Do(readConf)<br>	<span class="hljs-keyword">return</span> &amp;config<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">readConf</span><span class="hljs-params">()</span></span> &#123;<br>	viper.SetConfigName(<span class="hljs-string">&quot;app&quot;</span>)<br>	viper.SetConfigType(<span class="hljs-string">&quot;yml&quot;</span>)<br>	viper.AddConfigPath(<span class="hljs-string">&quot;.&quot;</span>)<br>	viper.AddConfigPath(<span class="hljs-string">&quot;./conf&quot;</span>)<br>	viper.AddConfigPath(<span class="hljs-string">&quot;../conf&quot;</span>)<br>	err := viper.ReadInConfig()<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;read config file err:&quot;</span> + err.Error())<br>	&#125;<br>	err = viper.Unmarshal(&amp;config)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;config file unmarshal err:&quot;</span> + err.Error())<br>	&#125;<br>	log.Infof(<span class="hljs-string">&quot;config === %+v&quot;</span>, config)<br>&#125;<br><br><span class="hljs-comment">// InitConfig åˆå§‹åŒ–æ—¥å¿—</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitConfig</span><span class="hljs-params">()</span></span> &#123;<br>	globalConf := GetGlobalConf() <span class="hljs-comment">//è·å–å…¨å±€é…ç½®æ–‡ä»¶</span><br>	<span class="hljs-comment">// è®¾ç½®æ—¥å¿—çº§åˆ«</span><br>	level, err := log.ParseLevel(globalConf.LogConfig.Level) <span class="hljs-comment">//å®ç°å­—ç¬¦ä¸²åˆ°log.Levelç±»å‹çš„è½¬æ¢</span><br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;log level parse err:&quot;</span> + err.Error())<br>	&#125;<br>	<span class="hljs-comment">// è®¾ç½®æ—¥å¿—æ ¼å¼ä¸ºjsonæ ¼å¼</span><br>	log.SetFormatter(&amp;logFormatter&#123;<br>		log.TextFormatter&#123;<br>			DisableColors:   <span class="hljs-literal">true</span>,<br>			TimestampFormat: <span class="hljs-string">&quot;2006-01-02 15:04:05&quot;</span>,<br>			FullTimestamp:   <span class="hljs-literal">true</span>,<br>		&#125;&#125;)<br>	log.SetReportCaller(<span class="hljs-literal">true</span>) <span class="hljs-comment">// æ‰“å°æ–‡ä»¶ä½ç½®ï¼Œè¡Œå·</span><br>	log.SetLevel(level)       <span class="hljs-comment">//è®¾ç½®æ—¥å¿—çš„è®°å½•çº§åˆ«</span><br>	<span class="hljs-keyword">switch</span> globalConf.LogConfig.LogPattern &#123;<br>	<span class="hljs-keyword">case</span> <span class="hljs-string">&quot;stdout&quot;</span>:<br>		log.SetOutput(os.Stdout)<br>	<span class="hljs-keyword">case</span> <span class="hljs-string">&quot;stderr&quot;</span>:<br>		log.SetOutput(os.Stderr)<br>	<span class="hljs-keyword">case</span> <span class="hljs-string">&quot;file&quot;</span>:<br>		logger, err := rlog.New(<br>			globalConf.LogConfig.LogPath+<span class="hljs-string">&quot;.%Y%m%d&quot;</span>,<br>			<span class="hljs-comment">//rlog.WithLinkName(globalConf.LogConf.LogPath),</span><br>			rlog.WithRotationCount(globalConf.LogConfig.SaveDays),<br>			<span class="hljs-comment">//rlog.WithMaxAge(time.Minute*3),</span><br>			rlog.WithRotationTime(time.Hour*<span class="hljs-number">24</span>),<br>		)<br>		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;log conf err: &quot;</span> + err.Error())<br>		&#125;<br>		log.SetOutput(logger)<br>	<span class="hljs-keyword">default</span>:<br>		<span class="hljs-built_in">panic</span>(<span class="hljs-string">&quot;log conf err, check log_pattern in logsvr.yaml&quot;</span>)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="ï¼ˆ2ï¼‰log-go"><a href="#ï¼ˆ2ï¼‰log-go" class="headerlink" title="ï¼ˆ2ï¼‰log.go"></a>ï¼ˆ2ï¼‰log.go</h3><p>â€‹	è¿™æ˜¯ä¸€ä¸ª Go è¯­è¨€åŒ…(package)çš„å®ç°ï¼Œå…¶ä¸­åŒ…å«äº†ä»¥ä¸‹å‡½æ•°å’Œç»“æ„ä½“ï¼š</p>
<ol>
<li><code>logFormatter</code>ï¼šè‡ªå®šä¹‰çš„æ—¥å¿—æ ¼å¼åŒ–ç»“æ„ä½“ï¼ŒåŒ…å« <code>Format</code> æ–¹æ³•ï¼Œç”¨äºæ ¼å¼åŒ–æ—¥å¿—è¾“å‡ºã€‚</li>
<li><code>setGinLog</code>ï¼šè®¾ç½® Gin æ¡†æ¶çš„æ—¥å¿—è¾“å‡ºç›®æ ‡çš„å‡½æ•°ï¼Œå°†æ—¥å¿—è¾“å‡ºåˆ°æŒ‡å®šçš„ io.Writer å¯¹è±¡ä¸­ã€‚</li>
</ol>
<p>å…·ä½“æ¥è¯´ï¼Œ<code>logFormatter</code> ç»“æ„ä½“é‡å†™äº† <code>TextFormatter</code> çš„ <code>Format</code> æ–¹æ³•ï¼Œé€šè¿‡è°ƒç”¨ <code>prettyCaller</code> å‡½æ•°æ¥è¾“å‡ºæ—¥å¿—æ‰€åœ¨çš„æ–‡ä»¶å’Œè¡Œå·ä¿¡æ¯ï¼ŒåŒæ—¶è¾“å‡ºæ—¥å¿—æ—¶é—´ã€æ—¥å¿—ç­‰çº§å’Œæ—¥å¿—å†…å®¹ï¼Œå¹¶è¿”å›æ ¼å¼åŒ–åçš„å­—èŠ‚æ•°ç»„ã€‚</p>
<p>åœ¨ <code>setGinLog</code> å‡½æ•°ä¸­ï¼Œé€šè¿‡å°† <code>out</code> å‚æ•°èµ‹å€¼ç»™ <code>gin.DefaultWriter</code> å’Œ <code>gin.DefaultErrorWriter</code>ï¼Œå°† Gin æ¡†æ¶çš„æ—¥å¿—è¾“å‡ºç›®æ ‡è®¾ç½®ä¸ºæŒ‡å®šçš„ io.Writer å¯¹è±¡ï¼Œä»¥æ­¤æ¥å®ç°æ—¥å¿—çš„è¾“å‡ºã€‚</p>
<h4 id="logFormatterç±»å‹"><a href="#logFormatterç±»å‹" class="headerlink" title="logFormatter	ç±»å‹"></a>logFormatter	ç±»å‹</h4><p>â€‹	<strong>tabFormatter tabæ•°æ®æ ¼å¼åŒ–</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> logFormatter <span class="hljs-keyword">struct</span> &#123;<br>	log.TextFormatter<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	å®šä¹‰äº†ä¸€ä¸ªæ–°çš„ç±»å‹ <code>logFormatter</code>ï¼Œå®ƒæ˜¯ <code>log.TextFormatter</code> çš„å­ç±»å‹ã€‚</p>
<p>â€‹	æ¢å¥è¯è¯´ï¼Œ<code>logFormatter</code> ç»§æ‰¿äº† <code>log.TextFormatter</code> ä¸­å®šä¹‰çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•ï¼Œå¹¶ä¸”å¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šæ·»åŠ é¢å¤–çš„å±æ€§å’Œæ–¹æ³•ã€‚</p>
<p>â€‹	è¿™ç§æ–¹å¼ç§°ä¸ºç»„åˆï¼Œå³å°†ä¸€ä¸ªæˆ–å¤šä¸ªç±»å‹ç»„åˆæˆä¸€ä¸ªæ–°ç±»å‹ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>logFormatter</code> å¯ä»¥ç”¨æ¥å®šåˆ¶åŒ– <code>logrus</code> æ—¥å¿—åº“ä¸­çš„æ—¥å¿—æ ¼å¼ã€‚</p>
<h4 id="Formatå‡½æ•°"><a href="#Formatå‡½æ•°" class="headerlink" title="Format	å‡½æ•°"></a>Format	å‡½æ•°</h4><p>â€‹	<strong>è‡ªå®šä¹‰æ—¥å¿—è¾“å‡ºæ ¼å¼</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *logFormatter)</span></span> Format(entry *log.Entry) ([]<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>) &#123;<br>	prettyCaller := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(frame *runtime.Frame)</span></span> <span class="hljs-type">string</span> &#123;<br>		_, fileName := filepath.Split(frame.File)<br>		<span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;%s:%d&quot;</span>, fileName, frame.Line)<br>	&#125;<br>	<span class="hljs-keyword">var</span> b *bytes.Buffer<br>	<span class="hljs-keyword">if</span> entry.Buffer != <span class="hljs-literal">nil</span> &#123;<br>		b = entry.Buffer<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		b = &amp;bytes.Buffer&#123;&#125;<br>	&#125;<br>	b.WriteString(fmt.Sprintf(<span class="hljs-string">&quot;[%s] %s&quot;</span>, entry.Time.Format(c.TimestampFormat), <span class="hljs-comment">// è¾“å‡ºæ—¥å¿—æ—¶é—´</span><br>		strings.ToUpper(entry.Level.String())))<br>	<span class="hljs-keyword">if</span> entry.HasCaller() &#123;<br>		b.WriteString(fmt.Sprintf(<span class="hljs-string">&quot;[%s]&quot;</span>, prettyCaller(entry.Caller))) <span class="hljs-comment">// è¾“å‡ºæ—¥å¿—æ‰€åœ¨æ–‡ä»¶ï¼Œè¡Œæ•°ä½ç½®</span><br>	&#125;<br>	b.WriteString(fmt.Sprintf(<span class="hljs-string">&quot; %s\n&quot;</span>, entry.Message)) <span class="hljs-comment">// è¾“å‡ºæ—¥å¿—å†…å®¹</span><br>	<span class="hljs-keyword">return</span> b.Bytes(), <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	å®šä¹‰äº†ä¸€ä¸ªå®ç°äº† log.Formatter æ¥å£çš„ logFormatter ç»“æ„ä½“ï¼Œå¹¶å®ç°äº† Format æ–¹æ³•ï¼Œç”¨äºæ ¼å¼åŒ–æ—¥å¿—è¾“å‡ºã€‚å…·ä½“æ¥è¯´ï¼ŒFormat æ–¹æ³•ä¼šæ¥æ”¶ä¸€ä¸ª log.Entry ç»“æ„ä½“æŒ‡é’ˆä½œä¸ºå‚æ•°ï¼Œè¯¥ç»“æ„ä½“åŒ…å«äº†æ—¥å¿—çš„æ—¶é—´ã€çº§åˆ«ã€æ¶ˆæ¯å†…å®¹ç­‰ä¿¡æ¯ï¼Œå¹¶è¿”å›ä¸€ä¸ªå­—èŠ‚æ•°ç»„å’Œä¸€ä¸ªé”™è¯¯å¯¹è±¡ã€‚</p>
<p>â€‹	åœ¨ Format æ–¹æ³•ä¸­ï¼Œé¦–å…ˆå®šä¹‰äº†ä¸€ä¸ª prettyCaller å‡½æ•°ï¼Œç”¨äºè·å–æ—¥å¿—è¾“å‡ºæ‰€åœ¨æ–‡ä»¶å’Œè¡Œæ•°ã€‚ç„¶åï¼Œæ ¹æ®ä¼ å…¥çš„ log.Entry æŒ‡é’ˆä¸­çš„ä¿¡æ¯ï¼Œå°†æ—¶é—´ã€çº§åˆ«ã€æ‰€åœ¨ä½ç½®ã€æ¶ˆæ¯å†…å®¹ç­‰ä¿¡æ¯ä¾æ¬¡è¾“å‡ºåˆ°ä¸€ä¸ª bytes.Buffer å¯¹è±¡ä¸­ï¼Œå¹¶æœ€ç»ˆè¿”å›è¯¥å¯¹è±¡çš„å­—èŠ‚æ•°ç»„è¡¨ç¤ºã€‚</p>
<p>â€‹	æ­¤å¤–ï¼Œè¿˜å®šä¹‰äº†ä¸€ä¸ªåä¸º setGinLog çš„å‡½æ•°ï¼Œç”¨äºè®¾ç½® gin æ¡†æ¶çš„æ—¥å¿—è¾“å‡ºåˆ°æŒ‡å®šçš„ io.Writer å¯¹è±¡ï¼Œé€šå¸¸ç”¨äºå°† gin çš„æ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶ä¸­ã€‚</p>
<h4 id="setGinLogå‡½æ•°"><a href="#setGinLogå‡½æ•°" class="headerlink" title="setGinLog	å‡½æ•°"></a>setGinLog	å‡½æ•°</h4><p>â€‹	<strong>ä¿®æ”¹ <code>gin</code> æ¡†æ¶çš„æ—¥å¿—è¾“å‡ºä½ç½®</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">setGinLog</span><span class="hljs-params">(out io.Writer)</span></span> &#123;<br>	gin.DefaultWriter = out<br>	gin.DefaultErrorWriter = out<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	æ¥æ”¶ä¸€ä¸ªå®ç°äº† <code>io.Writer</code> æ¥å£çš„å¯¹è±¡ä½œä¸ºå‚æ•° <code>out</code>ã€‚åœ¨å‡½æ•°å†…éƒ¨ï¼Œå°† <code>gin</code> æ¡†æ¶çš„é»˜è®¤æ—¥å¿—è¾“å‡ºå’Œé”™è¯¯è¾“å‡ºéƒ½è®¾ç½®ä¸º <code>out</code>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé€šè¿‡è°ƒç”¨è¿™ä¸ªå‡½æ•°å¯ä»¥ä¿®æ”¹ <code>gin</code> æ¡†æ¶çš„æ—¥å¿—è¾“å‡ºä½ç½®ã€‚</p>
<h4 id="å®Œæ•´ä»£ç -1"><a href="#å®Œæ•´ä»£ç -1" class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> config<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;bytes&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	log <span class="hljs-string">&quot;github.com/sirupsen/logrus&quot;</span><br>	<span class="hljs-string">&quot;io&quot;</span><br>	<span class="hljs-string">&quot;path/filepath&quot;</span><br>	<span class="hljs-string">&quot;runtime&quot;</span><br>	<span class="hljs-string">&quot;strings&quot;</span><br>)<br><br><span class="hljs-comment">//tabFormatter tabæ•°æ®æ ¼å¼åŒ–</span><br><span class="hljs-keyword">type</span> logFormatter <span class="hljs-keyword">struct</span> &#123;<br>	log.TextFormatter<br>&#125;<br><br><span class="hljs-comment">// Format è‡ªå®šä¹‰æ—¥å¿—è¾“å‡ºæ ¼å¼</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *logFormatter)</span></span> Format(entry *log.Entry) ([]<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>) &#123;<br>	prettyCaller := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(frame *runtime.Frame)</span></span> <span class="hljs-type">string</span> &#123;<br>		_, fileName := filepath.Split(frame.File)<br>		<span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;%s:%d&quot;</span>, fileName, frame.Line)<br>	&#125;<br>	<span class="hljs-keyword">var</span> b *bytes.Buffer<br>	<span class="hljs-keyword">if</span> entry.Buffer != <span class="hljs-literal">nil</span> &#123;<br>		b = entry.Buffer<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		b = &amp;bytes.Buffer&#123;&#125;<br>	&#125;<br>	b.WriteString(fmt.Sprintf(<span class="hljs-string">&quot;[%s] %s&quot;</span>, entry.Time.Format(c.TimestampFormat), <span class="hljs-comment">// è¾“å‡ºæ—¥å¿—æ—¶é—´</span><br>		strings.ToUpper(entry.Level.String())))<br>	<span class="hljs-keyword">if</span> entry.HasCaller() &#123;<br>		b.WriteString(fmt.Sprintf(<span class="hljs-string">&quot;[%s]&quot;</span>, prettyCaller(entry.Caller))) <span class="hljs-comment">// è¾“å‡ºæ—¥å¿—æ‰€åœ¨æ–‡ä»¶ï¼Œè¡Œæ•°ä½ç½®</span><br>	&#125;<br>	b.WriteString(fmt.Sprintf(<span class="hljs-string">&quot; %s\n&quot;</span>, entry.Message)) <span class="hljs-comment">// è¾“å‡ºæ—¥å¿—å†…å®¹</span><br>	<span class="hljs-keyword">return</span> b.Bytes(), <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">setGinLog</span><span class="hljs-params">(out io.Writer)</span></span> &#123;<br>	gin.DefaultWriter = out<br>	gin.DefaultErrorWriter = out<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="2ã€internalåŒ…"><a href="#2ã€internalåŒ…" class="headerlink" title="2ã€internalåŒ…"></a>2ã€internalåŒ…</h2><h3 id="ï¼ˆ1ï¼‰routeråŒ…"><a href="#ï¼ˆ1ï¼‰routeråŒ…" class="headerlink" title="ï¼ˆ1ï¼‰routeråŒ…"></a>ï¼ˆ1ï¼‰routeråŒ…</h3><h4 id="â‘ -router-go"><a href="#â‘ -router-go" class="headerlink" title="â‘  router.go"></a>â‘  router.go</h4><h4 id="setAppRunModeè®¾ç½®è¿è¡Œæ¨¡å¼"><a href="#setAppRunModeè®¾ç½®è¿è¡Œæ¨¡å¼" class="headerlink" title="setAppRunMode	è®¾ç½®è¿è¡Œæ¨¡å¼"></a>setAppRunMode	è®¾ç½®è¿è¡Œæ¨¡å¼</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">setAppRunMode</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">if</span> config.GetGlobalConf().AppConfig.RunMode == <span class="hljs-string">&quot;release&quot;</span> &#123;<br>		gin.SetMode(gin.ReleaseMode)<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	ç”¨äºè®¾ç½®åº”ç”¨ç¨‹åºè¿è¡Œæ¨¡å¼ã€‚å¦‚æœå…¨å±€é…ç½®ä¸­çš„ <code>AppConfig.RunMode</code> è®¾ç½®ä¸º <code>&quot;release&quot;</code>ï¼Œé‚£ä¹ˆä¼šå°† Gin æ¡†æ¶çš„æ¨¡å¼è®¾ç½®ä¸º Release æ¨¡å¼ã€‚</p>
<p>â€‹	åœ¨ Release æ¨¡å¼ä¸‹ï¼ŒGin æ¡†æ¶ä¼šç¦ç”¨ä¸€äº›è°ƒè¯•ä¿¡æ¯å’Œä¸­é—´ä»¶ï¼Œä»¥æé«˜åº”ç”¨ç¨‹åºçš„è¿è¡Œæ•ˆç‡å’Œå®‰å…¨æ€§ã€‚è¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„æœ€ä½³å®è·µï¼Œç‰¹åˆ«æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ã€‚</p>
<h4 id="AuthMiddleWareå‡½æ•°"><a href="#AuthMiddleWareå‡½æ•°" class="headerlink" title="AuthMiddleWareå‡½æ•°"></a>AuthMiddleWareå‡½æ•°</h4><p>â€‹	éªŒè¯ç”¨æˆ·èº«ä»½æ˜¯å¦åˆæ³•</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AuthMiddleWare</span><span class="hljs-params">()</span></span> gin.HandlerFunc &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>		<span class="hljs-keyword">if</span> session, err := c.Cookie(constant.SessionKey); err == <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">if</span> session != <span class="hljs-string">&quot;&quot;</span> &#123;<br>				c.Next()<br>				<span class="hljs-keyword">return</span><br>			&#125;<br>		&#125;<br>		<span class="hljs-comment">// è¿”å›é”™è¯¯</span><br>		c.JSON(http.StatusUnauthorized, gin.H&#123;<span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">&quot;err&quot;</span>&#125;)<br>		c.Abort()<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	ä¸­é—´ä»¶å‡½æ•°æ¥æ”¶ä¸€ä¸ª Gin ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆ<code>gin.Context</code>ï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ª <code>gin.HandlerFunc</code> ç±»å‹çš„å‡½æ•°ã€‚ä¸­é—´ä»¶å‡½æ•°é¦–å…ˆæ£€æŸ¥è¯·æ±‚å¤´ä¸­æ˜¯å¦åŒ…å«åä¸º <code>constant.SessionKey</code> çš„ cookieã€‚</p>
<p>â€‹	å¦‚æœ cookie å­˜åœ¨ä¸”ä¸ä¸ºç©ºï¼Œåˆ™è¯´æ˜ç”¨æˆ·å·²ç»ç™»å½•ï¼Œè°ƒç”¨ <code>c.Next()</code> æ–¹æ³•ï¼Œç»§ç»­å¤„ç†è¯¥è¯·æ±‚å¹¶ä¼ é€’ç»™åç»­å¤„ç†ç¨‹åºï¼›å¦åˆ™ï¼Œä¸­é—´ä»¶å‡½æ•°è¿”å›ä¸€ä¸ªçŠ¶æ€ç ä¸º <code>http.StatusUnauthorized</code> çš„ JSON å“åº”ï¼Œæç¤ºç”¨æˆ·æœªæˆæƒï¼Œå¹¶ç»ˆæ­¢è¯¥è¯·æ±‚çš„å¤„ç†ï¼Œè°ƒç”¨ <code>c.Abort()</code> æ–¹æ³•ç»ˆæ­¢åç»­å¤„ç†ç¨‹åºå‡½æ•°çš„æ‰§è¡Œã€‚</p>
<h4 id="InitRouterAndServe"><a href="#InitRouterAndServe" class="headerlink" title="InitRouterAndServe"></a>InitRouterAndServe</h4><p>â€‹	å‡½æ•°è·¯ç”±é…ç½®ã€å¯åŠ¨æœåŠ¡</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitRouterAndServe</span><span class="hljs-params">()</span></span> &#123;<br><br>	setAppRunMode()<br>	r := gin.Default()<br><br>	<span class="hljs-comment">// å¥åº·æ£€æŸ¥</span><br>	r.GET(<span class="hljs-string">&quot;ping&quot;</span>, api.Ping)<br>	<span class="hljs-comment">//å¥åº·æ£€æŸ¥</span><br>	<span class="hljs-comment">// ç”¨æˆ·æ³¨å†Œ</span><br>	r.POST(<span class="hljs-string">&quot;/user/register&quot;</span>, api.Register)<br>	<span class="hljs-comment">// ç”¨æˆ·ç™»å½•</span><br>	r.POST(<span class="hljs-string">&quot;/user/login&quot;</span>, api.Login)<br>	<span class="hljs-comment">// ç”¨æˆ·ç™»å‡º</span><br>	r.POST(<span class="hljs-string">&quot;/user/logout&quot;</span>, AuthMiddleWare(), api.Logout)<br>	<span class="hljs-comment">// è·å–ç”¨æˆ·ä¿¡æ¯</span><br>	r.GET(<span class="hljs-string">&quot;/user/get_user_info&quot;</span>, AuthMiddleWare(), api.GetUserInfo)<br>	<span class="hljs-comment">// æ›´æ–°ç”¨æˆ·ä¿¡æ¯</span><br>	r.POST(<span class="hljs-string">&quot;/user/update_nick_name&quot;</span>, AuthMiddleWare(), api.UpdateNickName)<br><br>	r.Static(<span class="hljs-string">&quot;/static/&quot;</span>, <span class="hljs-string">&quot;./web/static/&quot;</span>)<br>	r.Static(<span class="hljs-string">&quot;/upload/images/&quot;</span>, <span class="hljs-string">&quot;./web/upload/images/&quot;</span>)<br><br>	<span class="hljs-comment">// å¯åŠ¨server</span><br>	port := config.GetGlobalConf().AppConfig.Port<br>	<span class="hljs-keyword">if</span> err := r.Run(<span class="hljs-string">&quot;:&quot;</span> + strconv.Itoa(port)); err != <span class="hljs-literal">nil</span> &#123;<br>		log.Error(<span class="hljs-string">&quot;start server err:&quot;</span> + err.Error())<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯åˆå§‹åŒ–è·¯ç”±å¹¶å¯åŠ¨HTTP serverã€‚</p>
<p>â€‹	é¦–å…ˆè°ƒç”¨<code>setAppRunMode()</code>å‡½æ•°æ¥è®¾ç½®Ginæ¡†æ¶çš„è¿è¡Œæ¨¡å¼ã€‚ç„¶ååˆ›å»ºä¸€ä¸ªé»˜è®¤çš„Ginå®ä¾‹ï¼Œå¹¶ä½¿ç”¨<code>GET</code>æ–¹æ³•æ³¨å†Œäº†ä¸€ä¸ªåä¸ºâ€pingâ€çš„è·¯ç”±ï¼Œå¹¶å°†å…¶å¤„ç†å‡½æ•°è®¾ç½®ä¸º<code>api.Ping</code>ï¼Œè¯¥å‡½æ•°ç”¨äºå®ç°å¥åº·æ£€æŸ¥ã€‚</p>
<p>â€‹	æ¥ä¸‹æ¥æ³¨å†Œäº†ä¸€ç³»åˆ—å¤„ç†ç”¨æˆ·ç›¸å…³æ“ä½œçš„è·¯ç”±ï¼Œå¦‚æ³¨å†Œã€ç™»å½•ã€ç™»å‡ºã€è·å–ç”¨æˆ·ä¿¡æ¯ä»¥åŠæ›´æ–°ç”¨æˆ·æ˜µç§°ç­‰ã€‚å…¶ä¸­ï¼Œè®¿é—®éœ€è¦ç”¨æˆ·æˆæƒçš„è·¯ç”±æ—¶ï¼Œä½¿ç”¨äº†<code>AuthMiddleWare()</code>ä¸­é—´ä»¶å‡½æ•°æ¥éªŒè¯ç”¨æˆ·çš„ç™»å½•çŠ¶æ€ã€‚</p>
<p>â€‹	æœ€åï¼Œä½¿ç”¨<code>r.Static()</code>å‡½æ•°æ³¨å†Œäº†é™æ€æ–‡ä»¶æœåŠ¡ï¼ŒæŒ‡å®šäº†é™æ€æ–‡ä»¶çš„è·¯å¾„ã€‚æœ€åå¯åŠ¨HTTP serverï¼Œå¹¶æŒ‡å®šäº†ç«¯å£å·ã€‚å¦‚æœå¯åŠ¨å¤±è´¥ï¼Œå°†ä¼šè¾“å‡ºé”™è¯¯ä¿¡æ¯åˆ°æ—¥å¿—ä¸­ã€‚</p>
<h4 id="å®Œæ•´ä»£ç -2"><a href="#å®Œæ•´ä»£ç -2" class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> router<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	log <span class="hljs-string">&quot;github.com/sirupsen/logrus&quot;</span><br>	<span class="hljs-string">&quot;net/http&quot;</span><br>	<span class="hljs-string">&quot;strconv&quot;</span><br>	api <span class="hljs-string">&quot;user_system/api/http/v1&quot;</span><br>	<span class="hljs-string">&quot;user_system/config&quot;</span><br>	<span class="hljs-string">&quot;user_system/pkg/constant&quot;</span><br>)<br><br><span class="hljs-comment">// InitRouterAndServe è·¯ç”±é…ç½®ã€å¯åŠ¨æœåŠ¡</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitRouterAndServe</span><span class="hljs-params">()</span></span> &#123;<br><br>	setAppRunMode()<br>	r := gin.Default()<br><br>	<span class="hljs-comment">// å¥åº·æ£€æŸ¥</span><br>	r.GET(<span class="hljs-string">&quot;ping&quot;</span>, api.Ping)<br>	<span class="hljs-comment">//å¥åº·æ£€æŸ¥</span><br>	<span class="hljs-comment">// ç”¨æˆ·æ³¨å†Œ</span><br>	r.POST(<span class="hljs-string">&quot;/user/register&quot;</span>, api.Register)<br>	<span class="hljs-comment">// ç”¨æˆ·ç™»å½•</span><br>	r.POST(<span class="hljs-string">&quot;/user/login&quot;</span>, api.Login)<br>	<span class="hljs-comment">// ç”¨æˆ·ç™»å‡º</span><br>	r.POST(<span class="hljs-string">&quot;/user/logout&quot;</span>, AuthMiddleWare(), api.Logout)<br>	<span class="hljs-comment">// è·å–ç”¨æˆ·ä¿¡æ¯</span><br>	r.GET(<span class="hljs-string">&quot;/user/get_user_info&quot;</span>, AuthMiddleWare(), api.GetUserInfo)<br>	<span class="hljs-comment">// æ›´æ–°ç”¨æˆ·ä¿¡æ¯</span><br>	r.POST(<span class="hljs-string">&quot;/user/update_nick_name&quot;</span>, AuthMiddleWare(), api.UpdateNickName)<br><br>	r.Static(<span class="hljs-string">&quot;/static/&quot;</span>, <span class="hljs-string">&quot;./web/static/&quot;</span>)<br>	r.Static(<span class="hljs-string">&quot;/upload/images/&quot;</span>, <span class="hljs-string">&quot;./web/upload/images/&quot;</span>)<br><br>	<span class="hljs-comment">// å¯åŠ¨server</span><br>	port := config.GetGlobalConf().AppConfig.Port<br>	<span class="hljs-keyword">if</span> err := r.Run(<span class="hljs-string">&quot;:&quot;</span> + strconv.Itoa(port)); err != <span class="hljs-literal">nil</span> &#123;<br>		log.Error(<span class="hljs-string">&quot;start server err:&quot;</span> + err.Error())<br>	&#125;<br>&#125;<br><br><span class="hljs-comment">// setAppRunMode è®¾ç½®è¿è¡Œæ¨¡å¼</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">setAppRunMode</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">if</span> config.GetGlobalConf().AppConfig.RunMode == <span class="hljs-string">&quot;release&quot;</span> &#123;<br>		gin.SetMode(gin.ReleaseMode)<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AuthMiddleWare</span><span class="hljs-params">()</span></span> gin.HandlerFunc &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>		<span class="hljs-keyword">if</span> session, err := c.Cookie(constant.SessionKey); err == <span class="hljs-literal">nil</span> &#123;<br>			<span class="hljs-keyword">if</span> session != <span class="hljs-string">&quot;&quot;</span> &#123;<br>				c.Next()<br>				<span class="hljs-keyword">return</span><br>			&#125;<br>		&#125;<br>		<span class="hljs-comment">// è¿”å›é”™è¯¯</span><br>		c.JSON(http.StatusUnauthorized, gin.H&#123;<span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">&quot;err&quot;</span>&#125;)<br>		c.Abort()<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="ï¼ˆ2ï¼‰modelåŒ…"><a href="#ï¼ˆ2ï¼‰modelåŒ…" class="headerlink" title="ï¼ˆ2ï¼‰modelåŒ…"></a>ï¼ˆ2ï¼‰modelåŒ…</h3><h4 id="â‘ model-go"><a href="#â‘ model-go" class="headerlink" title="â‘ 	model.go"></a>â‘ 	model.go</h4><h5 id="CreateModelç±»å‹å†…åµŒmodel"><a href="#CreateModelç±»å‹å†…åµŒmodel" class="headerlink" title="CreateModelç±»å‹	å†…åµŒmodel"></a>CreateModelç±»å‹	å†…åµŒmodel</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> CreateModel <span class="hljs-keyword">struct</span> &#123;<br>	Creator    <span class="hljs-type">string</span>    <span class="hljs-string">`gorm:&quot;type:varchar(100);not null;default &#x27;&#x27;&quot;`</span><br>	CreateTime time.Time <span class="hljs-string">`gorm:&quot;autoCreateTime&quot;`</span> <span class="hljs-comment">// åœ¨åˆ›å»ºè®°å½•æ—¶è‡ªåŠ¨ç”Ÿæˆæ—¶é—´</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¿™ä¸ªæ˜¯ä¸€ä¸ª Golang ç»“æ„ä½“å®šä¹‰ï¼Œç”¨äºå®šä¹‰ä¸€ä¸ªæ•°æ®è¡¨æ¨¡å‹ã€‚å…¶ä¸­ <code>CreateModel</code> è¡¨ç¤ºä¸€ä¸ªæ¨¡å‹ï¼Œå®ƒåŒ…å«äº†ä¸¤ä¸ªå­—æ®µï¼š</p>
<p>â€‹	a.<code>Creator</code>ï¼šè¡¨ç¤ºæ¨¡å‹çš„åˆ›å»ºè€…ï¼Œç±»å‹ä¸ºå­—ç¬¦ä¸²ï¼Œå ç”¨æ•°æ®åº“ä¸­çš„ <code>varchar(100)</code> ç±»å‹ï¼Œä¸å…è®¸ä¸ºç©ºï¼Œå¦‚æœä¸å¡«åˆ™é»˜è®¤ä¸ºç©ºå­—ç¬¦ä¸²ã€‚</p>
<p>â€‹	b.<code>CreateTime</code>ï¼šè¡¨ç¤ºæ¨¡å‹çš„åˆ›å»ºæ—¶é—´ï¼Œç±»å‹ä¸º <code>time.Time</code>ï¼Œå®ƒæ˜¯åœ¨åˆ›å»ºè®°å½•æ—¶è‡ªåŠ¨ç”Ÿæˆçš„æ—¶é—´ã€‚</p>
<p>è¿™ä¸ªæ¨¡å‹æ˜¯ä½¿ç”¨ GORM æ¡†æ¶æ¥æ“ä½œæ•°æ®åº“çš„ï¼Œé€šè¿‡åœ¨å­—æ®µçš„ tag ä¸­æŒ‡å®šå„ç§çº¦æŸæ¡ä»¶ï¼Œä¾‹å¦‚ <code>type</code>ã€<code>not null</code>ã€<code>default</code>ã€<code>autoCreateTime</code> ç­‰æ¥æŒ‡å®šè¯¥å­—æ®µåœ¨æ•°æ®åº“ä¸­çš„å±æ€§å’Œè¡Œä¸ºã€‚</p>
<h5 id="ModifyModelç±»å‹å†…åµŒmodel"><a href="#ModifyModelç±»å‹å†…åµŒmodel" class="headerlink" title="ModifyModelç±»å‹	å†…åµŒmodel"></a>ModifyModelç±»å‹	å†…åµŒmodel</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> ModifyModel <span class="hljs-keyword">struct</span> &#123;<br>   Modifier   <span class="hljs-type">string</span>    <span class="hljs-string">`gorm:&quot;type:varchar(100);not null;default &#x27;&#x27;&quot;`</span><br>   ModifyTime time.Time <span class="hljs-string">`gorm:&quot;autoUpdateTime&quot;`</span> <span class="hljs-comment">// åœ¨æ›´æ–°è®°å½•æ—¶è‡ªåŠ¨ç”Ÿæˆæ—¶é—´</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¿™æ˜¯ä¸€ä¸ªåŒ…å«<code>Modifier</code>å’Œ<code>ModifyTime</code>å­—æ®µçš„ç»“æ„ä½“ï¼Œç”¨äºå¯¹è®°å½•è¿›è¡Œæ›´æ–°æ—¶è‡ªåŠ¨è®°å½•ä¿®æ”¹è€…å’Œä¿®æ”¹æ—¶é—´ã€‚</p>
<p>â€‹	<code>Modifier</code>å­—æ®µæ˜¯ä¸€ä¸ª<code>string</code>ç±»å‹ï¼Œç”¨äºè®°å½•æ›´æ–°æ“ä½œçš„äººå‘˜ï¼Œ<code>gorm:&quot;type:varchar(100);not null;default &#39;&#39;&quot;</code>è¡¨ç¤ºè¯¥å­—æ®µåœ¨æ•°æ®åº“ä¸­å¯¹åº”çš„ç±»å‹ä¸º<code>varchar(100)</code>ï¼Œä¸èƒ½ä¸ºç©ºï¼Œå¹¶ä¸”é»˜è®¤å€¼ä¸º<code>&#39;&#39;</code>ã€‚</p>
<p>â€‹	<code>ModifyTime</code>å­—æ®µæ˜¯ä¸€ä¸ª<code>time.Time</code>ç±»å‹ï¼Œç”¨äºè®°å½•æ›´æ–°æ“ä½œçš„æ—¶é—´ï¼Œ<code>gorm:&quot;autoUpdateTime&quot;</code>è¡¨ç¤ºè¯¥å­—æ®µåœ¨æ›´æ–°è®°å½•æ—¶ä¼šè‡ªåŠ¨æ›´æ–°ä¸ºå½“å‰æ—¶é—´ã€‚å½“è®°å½•è¢«æ›´æ–°æ—¶ï¼Œ<code>gorm</code>ä¼šè‡ªåŠ¨å°†å½“å‰æ—¶é—´èµ‹å€¼ç»™<code>ModifyTime</code>å­—æ®µã€‚</p>
<p>â€‹	è¿™ç§æ–¹å¼å¯ä»¥æ–¹ä¾¿åœ°è®°å½•è®°å½•çš„ä¿®æ”¹è€…å’Œä¿®æ”¹æ—¶é—´ï¼Œä¸”ä¸éœ€è¦æ‰‹åŠ¨åœ¨ä»£ç ä¸­æ·»åŠ ä¿®æ”¹è€…å’Œä¿®æ”¹æ—¶é—´çš„è®°å½•ã€‚åŒæ—¶ï¼Œç”±äº<code>gorm</code>è‡ªåŠ¨æ›´æ–°æ—¶é—´çš„ç‰¹æ€§ï¼Œç¡®ä¿äº†è®°å½•çš„ä¿®æ”¹æ—¶é—´çš„å‡†ç¡®æ€§ã€‚</p>
<h5 id="Userç±»å‹ç”¨æˆ·"><a href="#Userç±»å‹ç”¨æˆ·" class="headerlink" title="Userç±»å‹	ç”¨æˆ·"></a>Userç±»å‹	ç”¨æˆ·</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;<br>	CreateModel<br>	ModifyModel<br>	ID       <span class="hljs-type">int</span>    <span class="hljs-string">`gorm:&quot;column:id&quot;`</span><br>	Name     <span class="hljs-type">string</span> <span class="hljs-string">`gorm:&quot;column:name&quot;`</span>     <span class="hljs-comment">//å§“å</span><br>	Gender   <span class="hljs-type">string</span> <span class="hljs-string">`gorm:&quot;column:gender&quot;`</span>   <span class="hljs-comment">//æ€§åˆ«</span><br>	Age      <span class="hljs-type">int</span>    <span class="hljs-string">`gorm:&quot;column:age&quot;`</span>      <span class="hljs-comment">//å¹´é¾„</span><br>	PassWord <span class="hljs-type">string</span> <span class="hljs-string">`gorm:&quot;column:password&quot;`</span> <span class="hljs-comment">//å¯†ç </span><br>	NickName <span class="hljs-type">string</span> <span class="hljs-string">`gorm:&quot;column:nickname&quot;`</span> <span class="hljs-comment">//æ˜µç§°</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	å®šä¹‰äº†ä¸€ä¸ªç»“æ„ä½“ <code>User</code>ï¼Œå…¶ä¸­åŒ…å«äº† <code>CreateModel</code> å’Œ <code>ModifyModel</code> ä¸¤ä¸ªåµŒå¥—çš„ç»“æ„ä½“ã€‚</p>
<p>â€‹	<code>CreateModel</code> ç»“æ„ä½“ä¸­åŒ…å«äº†ä¸€ä¸ªå­—æ®µ <code>CreateTime</code>ï¼Œå®ƒçš„ç±»å‹ä¸º <code>time.Time</code>ï¼Œè¡¨ç¤ºåˆ›å»ºè®°å½•æ—¶è‡ªåŠ¨ç”Ÿæˆçš„æ—¶é—´ã€‚</p>
<p>â€‹	<code>ModifyModel</code> ç»“æ„ä½“ä¸­åŒ…å«äº†ä¸€ä¸ªå­—æ®µ <code>ModifyTime</code>ï¼Œå®ƒçš„ç±»å‹ä¹Ÿä¸º <code>time.Time</code>ï¼Œè¡¨ç¤ºæ›´æ–°è®°å½•æ—¶è‡ªåŠ¨ç”Ÿæˆçš„æ—¶é—´ã€‚</p>
<p>â€‹	<code>User</code> ç»“æ„ä½“ä¸­è¿˜åŒ…å«äº†å…¶ä»–å­—æ®µï¼Œå¦‚ <code>ID</code>ã€<code>Name</code>ã€<code>Gender</code>ã€<code>Age</code>ã€<code>PassWord</code> å’Œ <code>NickName</code> ç­‰å­—æ®µï¼Œè¿™äº›å­—æ®µå¯ä»¥é€šè¿‡åœ¨æ•°æ®åº“ä¸­åˆ›å»ºå¯¹åº”çš„åˆ—æ¥å­˜å‚¨æ•°æ®ã€‚åŒæ—¶ï¼Œç”±äº <code>User</code> ç»“æ„ä½“åµŒå¥—äº† <code>CreateModel</code> å’Œ <code>ModifyModel</code> ç»“æ„ä½“ï¼Œå› æ­¤åœ¨æ’å…¥æˆ–æ›´æ–° <code>User</code> è®°å½•æ—¶ï¼Œç›¸åº”çš„æ—¶é—´å­—æ®µä¼šè‡ªåŠ¨å¡«å……ä¸ºå½“å‰æ—¶é—´ã€‚</p>
<h5 id="TableName-è¡¨å"><a href="#TableName-è¡¨å" class="headerlink" title="TableName è¡¨å"></a>TableName è¡¨å</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *User)</span></span> TableName() <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;t_user&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¿™æ˜¯ä¸€ä¸ª GORM æ¨¡å‹ç»“æ„ä½“æ–¹æ³•ï¼Œç”¨äºæŒ‡å®šæ¨¡å‹å¯¹åº”çš„æ•°æ®åº“è¡¨åã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>User</code> æ¨¡å‹å¯¹åº”çš„æ•°æ®åº“è¡¨åä¸º <code>t_user</code>ã€‚è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯å°†æ¨¡å‹å’Œè¡¨åè¿›è¡Œç»‘å®šï¼Œä½¿å¾— GORM å¯ä»¥è‡ªåŠ¨åœ°å°†æ¨¡å‹çš„æ•°æ®å­˜å‚¨åˆ°å¯¹åº”çš„æ•°æ®åº“è¡¨ä¸­ã€‚å¦‚æœæ²¡æœ‰æ˜¾å¼æŒ‡å®šè¡¨åï¼Œåˆ™ GORM ä¼šé»˜è®¤ä½¿ç”¨æ¨¡å‹åçš„å¤æ•°å½¢å¼ä½œä¸ºè¡¨åã€‚</p>
<h5 id="å®Œæ•´ä»£ç -3"><a href="#å®Œæ•´ä»£ç -3" class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> model<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;time&quot;</span><br><br><span class="hljs-comment">// CreateModel å†…åµŒmodel</span><br><span class="hljs-keyword">type</span> CreateModel <span class="hljs-keyword">struct</span> &#123;<br>	Creator    <span class="hljs-type">string</span>    <span class="hljs-string">`gorm:&quot;type:varchar(100);not null;default &#x27;&#x27;&quot;`</span><br>	CreateTime time.Time <span class="hljs-string">`gorm:&quot;autoCreateTime&quot;`</span> <span class="hljs-comment">// åœ¨åˆ›å»ºè®°å½•æ—¶è‡ªåŠ¨ç”Ÿæˆæ—¶é—´</span><br>&#125;<br><br><span class="hljs-comment">// ModifyModel å†…åµŒmodel</span><br><span class="hljs-keyword">type</span> ModifyModel <span class="hljs-keyword">struct</span> &#123;<br>	Modifier   <span class="hljs-type">string</span>    <span class="hljs-string">`gorm:&quot;type:varchar(100);not null;default &#x27;&#x27;&quot;`</span><br>	ModifyTime time.Time <span class="hljs-string">`gorm:&quot;autoUpdateTime&quot;`</span> <span class="hljs-comment">// åœ¨æ›´æ–°è®°å½•æ—¶è‡ªåŠ¨ç”Ÿæˆæ—¶é—´</span><br>&#125;<br><br><span class="hljs-comment">// User ç”¨æˆ·</span><br><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;<br>	CreateModel<br>	ModifyModel<br>	ID       <span class="hljs-type">int</span>    <span class="hljs-string">`gorm:&quot;column:id&quot;`</span><br>	Name     <span class="hljs-type">string</span> <span class="hljs-string">`gorm:&quot;column:name&quot;`</span>     <span class="hljs-comment">//å§“å</span><br>	Gender   <span class="hljs-type">string</span> <span class="hljs-string">`gorm:&quot;column:gender&quot;`</span>   <span class="hljs-comment">//æ€§åˆ«</span><br>	Age      <span class="hljs-type">int</span>    <span class="hljs-string">`gorm:&quot;column:age&quot;`</span>      <span class="hljs-comment">//å¹´é¾„</span><br>	PassWord <span class="hljs-type">string</span> <span class="hljs-string">`gorm:&quot;column:password&quot;`</span> <span class="hljs-comment">//å¯†ç </span><br>	NickName <span class="hljs-type">string</span> <span class="hljs-string">`gorm:&quot;column:nickname&quot;`</span> <span class="hljs-comment">//æ˜µç§°</span><br>&#125;<br><br><span class="hljs-comment">// TableName è¡¨å</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *User)</span></span> TableName() <span class="hljs-type">string</span> &#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;t_user&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="ï¼ˆ3ï¼‰daoåŒ…"><a href="#ï¼ˆ3ï¼‰daoåŒ…" class="headerlink" title="ï¼ˆ3ï¼‰daoåŒ…"></a>ï¼ˆ3ï¼‰daoåŒ…</h3><h4 id="â‘ user-go"><a href="#â‘ user-go" class="headerlink" title="â‘ 	user.go"></a>â‘ 	user.go</h4><h5 id="CreateUserå‡½æ•°åˆ›å»ºä¸€ä¸ªç”¨æˆ·"><a href="#CreateUserå‡½æ•°åˆ›å»ºä¸€ä¸ªç”¨æˆ·" class="headerlink" title="CreateUserå‡½æ•°	åˆ›å»ºä¸€ä¸ªç”¨æˆ·"></a>CreateUserå‡½æ•°	åˆ›å»ºä¸€ä¸ªç”¨æˆ·</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CreateUser</span><span class="hljs-params">(user *model.User)</span></span> <span class="hljs-type">error</span> &#123;<br>	<span class="hljs-keyword">if</span> err := utils.GetDB().Model(&amp;model.User&#123;&#125;).Create(user).Error; err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;CreateUser fail: %v&quot;</span>, err)<br>		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;CreateUser fail: %v&quot;</span>, err)<br>	&#125;<br>	log.Infof(<span class="hljs-string">&quot;insert success&quot;</span>)<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	ç”¨äºåœ¨æ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨æˆ·è®°å½•ã€‚å‡½æ•°æ¥å—ä¸€ä¸ªæŒ‡å‘model.Userç±»å‹ç»“æ„ä½“çš„æŒ‡é’ˆä½œä¸ºå‚æ•°ï¼Œè¯¥ç»“æ„ä½“è¡¨ç¤ºä¸€ä¸ªç”¨æˆ·çš„æ•°æ®ã€‚</p>
<p>â€‹	å‡½æ•°é¦–å…ˆä½¿ç”¨utilsåŒ…ä¸­çš„GetDBå‡½æ•°è·å–ä¸€ä¸ªæ•°æ®åº“å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨è¯¥å¯¹è±¡çš„Modelæ–¹æ³•æŒ‡å®šè¦æ“ä½œçš„æ•°æ®åº“è¡¨ï¼ˆmodel.User{}è¡¨ç¤ºt_userè¡¨ï¼‰ã€‚ç„¶åï¼Œå®ƒä½¿ç”¨è¯¥è¡¨çš„Createæ–¹æ³•æ¥å°†ä¼ å…¥çš„userç»“æ„ä½“åˆ›å»ºä¸ºä¸€æ¡æ–°è®°å½•ã€‚å¦‚æœåˆ›å»ºè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œå‡½æ•°ä¼šè®°å½•ä¸€ä¸ªé”™è¯¯æ—¥å¿—ï¼Œå¹¶è¿”å›ä¸€ä¸ªé”™è¯¯ã€‚å¦åˆ™ï¼Œå‡½æ•°è®°å½•ä¸€ä¸ªæˆåŠŸçš„ä¿¡æ¯æ—¥å¿—å¹¶è¿”å›nilè¡¨ç¤ºæ²¡æœ‰é”™è¯¯ã€‚</p>
<h5 id="GetUserByNameå‡½æ•°æ ¹æ®å§“åè·å–ç”¨æˆ·"><a href="#GetUserByNameå‡½æ•°æ ¹æ®å§“åè·å–ç”¨æˆ·" class="headerlink" title="GetUserByNameå‡½æ•°	æ ¹æ®å§“åè·å–ç”¨æˆ·"></a>GetUserByNameå‡½æ•°	æ ¹æ®å§“åè·å–ç”¨æˆ·</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetUserByName</span><span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> (*model.User, <span class="hljs-type">error</span>) &#123;<br>	user := &amp;model.User&#123;&#125;<br>	<span class="hljs-keyword">if</span> err := utils.GetDB().Model(model.User&#123;&#125;).Where(<span class="hljs-string">&quot;name=?&quot;</span>, name).First(user).Error; err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">if</span> err.Error() == gorm.ErrRecordNotFound.Error() &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>		&#125;<br>		log.Errorf(<span class="hljs-string">&quot;GetUserByName fail:%v&quot;</span>, err)<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;GetUserByName fail:%v&quot;</span>, err)<br>	&#125;<br>	<span class="hljs-keyword">return</span> user, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¯¥å‡½æ•°ç”¨äºä»æ•°æ®åº“ä¸­æŸ¥æ‰¾ä¸€ä¸ªæŒ‡å®šåç§°çš„ç”¨æˆ·ï¼Œå¹¶è¿”å›ä¸€ä¸ªæŒ‡å‘è¯¥ç”¨æˆ·çš„æŒ‡é’ˆã€‚å¦‚æœæ‰¾ä¸åˆ°è¯¥ç”¨æˆ·ï¼Œåˆ™è¿”å›nilã€‚</p>
<p>â€‹	å®ƒé‡‡ç”¨ä¸€ä¸ªåç§°å­—ç¬¦ä¸²ä½œä¸ºè¾“å…¥å‚æ•°ï¼Œå¹¶ä½¿ç”¨è¯¥å‚æ•°åœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢åŒ¹é…çš„ç”¨æˆ·è®°å½•ã€‚å¦‚æœæŸ¥è¯¢æˆåŠŸï¼Œå®ƒå°†è¿”å›æŒ‡å‘ç”¨æˆ·è®°å½•çš„æŒ‡é’ˆï¼›å¦åˆ™ï¼Œå®ƒå°†è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œè¯¥é”™è¯¯å°†æè¿°æŸ¥è¯¢å¤±è´¥çš„åŸå› ã€‚</p>
<p>â€‹	åœ¨è¯¥å‡½æ•°å†…éƒ¨ï¼Œå®ƒä½¿ç”¨äº†<code>gorm</code>åº“æä¾›çš„æ–¹æ³•æ¥æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶å°†æŸ¥è¯¢ç»“æœå­˜å‚¨åœ¨ä¸€ä¸ªæŒ‡å‘<code>User</code>ç»“æ„ä½“çš„æŒ‡é’ˆä¸­ã€‚å¦‚æœæŸ¥è¯¢æœªèƒ½è¿”å›ä»»ä½•ç»“æœï¼Œå³æŒ‡å®šåç§°çš„ç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ™è¯¥å‡½æ•°å°†è¿”å›nilã€‚å¦åˆ™ï¼Œå®ƒå°†è¿”å›ä¸€ä¸ªæŒ‡å‘åŒ…å«åŒ¹é…ç”¨æˆ·ä¿¡æ¯çš„ç»“æ„ä½“çš„æŒ‡é’ˆã€‚</p>
<h5 id="UpdateUserInfo-æ›´æ–°æ˜µç§°"><a href="#UpdateUserInfo-æ›´æ–°æ˜µç§°" class="headerlink" title="UpdateUserInfo æ›´æ–°æ˜µç§°"></a>UpdateUserInfo æ›´æ–°æ˜µç§°</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UpdateUserInfo</span><span class="hljs-params">(userName <span class="hljs-type">string</span>, user *model.User)</span></span> <span class="hljs-type">int64</span> &#123;<br>	<span class="hljs-keyword">return</span> utils.GetDB().Model(&amp;model.User&#123;&#125;).Where(<span class="hljs-string">&quot;`name` = ?&quot;</span>, userName).Updates(user).RowsAffected<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¿™ä¸ªå‡½æ•°çš„åŠŸèƒ½æ˜¯æ›´æ–°æ•°æ®åº“ä¸­ç”¨æˆ·ä¿¡æ¯ã€‚å®ƒæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯userNameï¼Œä»£è¡¨è¦æ›´æ–°ä¿¡æ¯çš„ç”¨æˆ·çš„ç”¨æˆ·åï¼›å¦ä¸€ä¸ªæ˜¯useræŒ‡é’ˆï¼Œå®ƒæ˜¯è¦æ›´æ–°çš„ç”¨æˆ·ä¿¡æ¯ã€‚</p>
<p>â€‹	åœ¨å‡½æ•°å†…éƒ¨ï¼Œä½¿ç”¨<code>utils.GetDB()</code>æ–¹æ³•è·å–æ•°æ®åº“è¿æ¥å¯¹è±¡ï¼Œç„¶åä½¿ç”¨<code>Model</code>æ–¹æ³•æŒ‡å®šæ“ä½œçš„æ•°æ®è¡¨ã€‚<code>Where</code>æ–¹æ³•æ ¹æ®æŒ‡å®šçš„ç”¨æˆ·åæŸ¥è¯¢è¦æ›´æ–°çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶ä½¿ç”¨<code>Updates</code>æ–¹æ³•å°†ç”¨æˆ·ä¿¡æ¯æ›´æ–°åˆ°æ•°æ®åº“ä¸­ã€‚æœ€åï¼Œ<code>RowsAffected</code>æ–¹æ³•è¿”å›æ›´æ–°çš„è¡Œæ•°ã€‚</p>
<p>â€‹	è¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼æ˜¯æ›´æ–°çš„è¡Œæ•°ï¼Œå¯ä»¥ç”¨äºåˆ¤æ–­æ›´æ–°æ˜¯å¦æˆåŠŸã€‚</p>
<h5 id="å®Œæ•´ä»£ç -4"><a href="#å®Œæ•´ä»£ç -4" class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> dao<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	log <span class="hljs-string">&quot;github.com/sirupsen/logrus&quot;</span><br>	<span class="hljs-string">&quot;gorm.io/gorm&quot;</span><br>	<span class="hljs-string">&quot;user_system/internal/model&quot;</span><br>	<span class="hljs-string">&quot;user_system/utils&quot;</span><br>)<br><br><span class="hljs-comment">// GetUserByName æ ¹æ®å§“åè·å–ç”¨æˆ·</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetUserByName</span><span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> (*model.User, <span class="hljs-type">error</span>) &#123;<br>	user := &amp;model.User&#123;&#125;<br>	<span class="hljs-keyword">if</span> err := utils.GetDB().Model(model.User&#123;&#125;).Where(<span class="hljs-string">&quot;name=?&quot;</span>, name).First(user).Error; err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">if</span> err.Error() == gorm.ErrRecordNotFound.Error() &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span><br>		&#125;<br>		log.Errorf(<span class="hljs-string">&quot;GetUserByName fail:%v&quot;</span>, err)<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;GetUserByName fail:%v&quot;</span>, err)<br>	&#125;<br>	<span class="hljs-keyword">return</span> user, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// CreateUser åˆ›å»ºä¸€ä¸ªç”¨æˆ·</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">CreateUser</span><span class="hljs-params">(user *model.User)</span></span> <span class="hljs-type">error</span> &#123;<br>	<span class="hljs-keyword">if</span> err := utils.GetDB().Model(&amp;model.User&#123;&#125;).Create(user).Error; err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;CreateUser fail: %v&quot;</span>, err)<br>		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;CreateUser fail: %v&quot;</span>, err)<br>	&#125;<br>	log.Infof(<span class="hljs-string">&quot;insert success&quot;</span>)<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// UpdateUserInfo æ›´æ–°æ˜µç§°</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UpdateUserInfo</span><span class="hljs-params">(userName <span class="hljs-type">string</span>, user *model.User)</span></span> <span class="hljs-type">int64</span> &#123;<br>	<span class="hljs-keyword">return</span> utils.GetDB().Model(&amp;model.User&#123;&#125;).Where(<span class="hljs-string">&quot;`name` = ?&quot;</span>, userName).Updates(user).RowsAffected<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="ï¼ˆ4ï¼‰serviceåŒ…"><a href="#ï¼ˆ4ï¼‰serviceåŒ…" class="headerlink" title="ï¼ˆ4ï¼‰serviceåŒ…"></a>ï¼ˆ4ï¼‰serviceåŒ…</h3><h4 id="â‘ entity-go"><a href="#â‘ entity-go" class="headerlink" title="â‘ 	entity.go"></a>â‘ 	entity.go</h4><h5 id="RegisterRequestç±»å‹æ³¨å†Œè¯·æ±‚"><a href="#RegisterRequestç±»å‹æ³¨å†Œè¯·æ±‚" class="headerlink" title="RegisterRequestç±»å‹	æ³¨å†Œè¯·æ±‚"></a>RegisterRequestç±»å‹	æ³¨å†Œè¯·æ±‚</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> RegisterRequest <span class="hljs-keyword">struct</span> &#123;<br>	UserName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;user_name&quot;`</span><br>	Password <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;pass_word&quot;`</span><br>	Age      <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;age&quot;`</span><br>	Gender   <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;gender&quot;`</span><br>	NickName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;nick_name&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>RegisterRequest</code> æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼ŒåŒ…å«äº†æ³¨å†Œè¯·æ±‚çš„å‚æ•°ä¿¡æ¯ã€‚å…¶ä¸­åŒ…æ‹¬ï¼š</p>
<ul>
<li><code>UserName</code>ï¼šå­—ç¬¦ä¸²ç±»å‹ï¼Œè¡¨ç¤ºç”¨æˆ·åã€‚</li>
<li><code>Password</code>ï¼šå­—ç¬¦ä¸²ç±»å‹ï¼Œè¡¨ç¤ºç”¨æˆ·å¯†ç ã€‚</li>
<li><code>Age</code>ï¼šæ•´å‹ï¼Œè¡¨ç¤ºç”¨æˆ·å¹´é¾„ã€‚</li>
<li><code>Gender</code>ï¼šå­—ç¬¦ä¸²ç±»å‹ï¼Œè¡¨ç¤ºç”¨æˆ·æ€§åˆ«ã€‚</li>
<li><code>NickName</code>ï¼šå­—ç¬¦ä¸²ç±»å‹ï¼Œè¡¨ç¤ºç”¨æˆ·æ˜µç§°ã€‚</li>
</ul>
<h5 id="LoginRequestç±»å‹-ç™»é™†è¯·æ±‚"><a href="#LoginRequestç±»å‹-ç™»é™†è¯·æ±‚" class="headerlink" title="LoginRequestç±»å‹ ç™»é™†è¯·æ±‚"></a>LoginRequestç±»å‹ ç™»é™†è¯·æ±‚</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> LoginRequest <span class="hljs-keyword">struct</span> &#123;<br>	UserName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;user_name&quot;`</span><br>	PassWord <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;pass_word&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>LoginRequest </code>ç»“æ„ä½“ï¼Œç”¨äºè¡¨ç¤ºç™»å½•è¯·æ±‚ã€‚å®ƒåŒ…å«ä¸¤ä¸ªå­—æ®µï¼š</p>
<ul>
<li><code>UserName</code>ï¼šè¡¨ç¤ºç”¨æˆ·çš„åç§°çš„å­—ç¬¦ä¸²ç±»å‹ã€‚</li>
<li><code>PassWord</code>ï¼šè¡¨ç¤ºç”¨æˆ·å¯†ç çš„å­—ç¬¦ä¸²ç±»å‹ã€‚</li>
</ul>
<h5 id="LogoutRequestç±»å‹ç™»å‡ºè¯·æ±‚"><a href="#LogoutRequestç±»å‹ç™»å‡ºè¯·æ±‚" class="headerlink" title="LogoutRequestç±»å‹	ç™»å‡ºè¯·æ±‚"></a>LogoutRequestç±»å‹	ç™»å‡ºè¯·æ±‚</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> LogoutRequest <span class="hljs-keyword">struct</span> &#123;<br>	UserName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;user_name&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>UserName</code>ï¼šè¡¨ç¤ºè¦æ³¨é”€ç”¨æˆ·çš„ç”¨æˆ·åï¼ˆstringç±»å‹ï¼‰ã€‚</p>
<h5 id="GetUserInfoRequest-è·å–ç”¨æˆ·ä¿¡æ¯è¯·æ±‚"><a href="#GetUserInfoRequest-è·å–ç”¨æˆ·ä¿¡æ¯è¯·æ±‚" class="headerlink" title="GetUserInfoRequest è·å–ç”¨æˆ·ä¿¡æ¯è¯·æ±‚"></a>GetUserInfoRequest è·å–ç”¨æˆ·ä¿¡æ¯è¯·æ±‚</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> GetUserInfoRequest <span class="hljs-keyword">struct</span> &#123;<br>   UserName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;user_name&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>ä¸€ä¸ªè·å–ç”¨æˆ·ä¿¡æ¯çš„è¯·æ±‚ç»“æ„ä½“ï¼Œå®ƒåªæœ‰ä¸€ä¸ªå­—æ®µï¼š</p>
<ul>
<li>UserNameï¼šè¡¨ç¤ºè¦è·å–ä¿¡æ¯çš„ç”¨æˆ·çš„ç”¨æˆ·åï¼Œç±»å‹ä¸ºå­—ç¬¦ä¸²ã€‚</li>
</ul>
<h5 id="GetUserInfoResponse-è·å–ç”¨æˆ·ä¿¡æ¯è¿”å›ç»“æ„"><a href="#GetUserInfoResponse-è·å–ç”¨æˆ·ä¿¡æ¯è¿”å›ç»“æ„" class="headerlink" title="GetUserInfoResponse è·å–ç”¨æˆ·ä¿¡æ¯è¿”å›ç»“æ„"></a>GetUserInfoResponse è·å–ç”¨æˆ·ä¿¡æ¯è¿”å›ç»“æ„</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> GetUserInfoResponse <span class="hljs-keyword">struct</span> &#123;<br>   UserName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;user_name&quot;`</span><br>   Age      <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;age&quot;`</span><br>   Gender   <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;gender&quot;`</span><br>   PassWord <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;pass_word&quot;`</span><br>   NickName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;nick_name&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>GetUserInfoResponse</code> æ˜¯è·å–ç”¨æˆ·ä¿¡æ¯çš„è¿”å›ç»“æ„ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š</p>
<ul>
<li><code>UserName</code>ï¼šç”¨æˆ·åç§°ã€‚</li>
<li><code>Age</code>ï¼šç”¨æˆ·å¹´é¾„ã€‚</li>
<li><code>Gender</code>ï¼šç”¨æˆ·æ€§åˆ«ã€‚</li>
<li><code>PassWord</code>ï¼šç”¨æˆ·å¯†ç ã€‚</li>
<li><code>NickName</code>ï¼šç”¨æˆ·æ˜µç§°ã€‚</li>
</ul>
<h5 id="UpdateNickNameRequest-ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯è¿”å›ç»“æ„"><a href="#UpdateNickNameRequest-ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯è¿”å›ç»“æ„" class="headerlink" title="UpdateNickNameRequest ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯è¿”å›ç»“æ„"></a>UpdateNickNameRequest ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯è¿”å›ç»“æ„</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> UpdateNickNameRequest <span class="hljs-keyword">struct</span> &#123;<br>   UserName    <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;user_name&quot;`</span><br>   NewNickName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;new_nick_name&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¡¨ç¤ºä¿®æ”¹ç”¨æˆ·æ˜µç§°çš„è¯·æ±‚ã€‚å®ƒæœ‰ä¸¤ä¸ªå­—æ®µï¼š</p>
<ul>
<li>UserNameï¼šå­—ç¬¦ä¸²ç±»å‹ï¼Œè¡¨ç¤ºè¦ä¿®æ”¹æ˜µç§°çš„ç”¨æˆ·çš„åç§°ã€‚</li>
<li>NewNickNameï¼šå­—ç¬¦ä¸²ç±»å‹ï¼Œè¡¨ç¤ºç”¨æˆ·è¦ä¿®æ”¹çš„æ–°æ˜µç§°ã€‚</li>
</ul>
<h5 id="å®Œæ•´ä»£ç -5"><a href="#å®Œæ•´ä»£ç -5" class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> service<br><br><span class="hljs-comment">// RegisterRequest æ³¨å†Œè¯·æ±‚</span><br><span class="hljs-keyword">type</span> RegisterRequest <span class="hljs-keyword">struct</span> &#123;<br>	UserName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;user_name&quot;`</span><br>	Password <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;pass_word&quot;`</span><br>	Age      <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;age&quot;`</span><br>	Gender   <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;gender&quot;`</span><br>	NickName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;nick_name&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// LoginRequest ç™»é™†è¯·æ±‚</span><br><span class="hljs-keyword">type</span> LoginRequest <span class="hljs-keyword">struct</span> &#123;<br>	UserName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;user_name&quot;`</span><br>	PassWord <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;pass_word&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// LogoutRequest ç™»å‡ºè¯·æ±‚</span><br><span class="hljs-keyword">type</span> LogoutRequest <span class="hljs-keyword">struct</span> &#123;<br>	UserName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;user_name&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// GetUserInfoRequest è·å–ç”¨æˆ·ä¿¡æ¯è¯·æ±‚</span><br><span class="hljs-keyword">type</span> GetUserInfoRequest <span class="hljs-keyword">struct</span> &#123;<br>	UserName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;user_name&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// GetUserInfoResponse è·å–ç”¨æˆ·ä¿¡æ¯è¿”å›ç»“æ„</span><br><span class="hljs-keyword">type</span> GetUserInfoResponse <span class="hljs-keyword">struct</span> &#123;<br>	UserName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;user_name&quot;`</span><br>	Age      <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;age&quot;`</span><br>	Gender   <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;gender&quot;`</span><br>	PassWord <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;pass_word&quot;`</span><br>	NickName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;nick_name&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// UpdateNickNameRequest ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯è¿”å›ç»“æ„</span><br><span class="hljs-keyword">type</span> UpdateNickNameRequest <span class="hljs-keyword">struct</span> &#123;<br>	UserName    <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;user_name&quot;`</span><br>	NewNickName <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;new_nick_name&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="â‘¡user-go"><a href="#â‘¡user-go" class="headerlink" title="â‘¡	user.go"></a>â‘¡	user.go</h4><h5 id="Registerå‡½æ•°ç”¨æˆ·æ³¨å†Œ"><a href="#Registerå‡½æ•°ç”¨æˆ·æ³¨å†Œ" class="headerlink" title="Registerå‡½æ•°	ç”¨æˆ·æ³¨å†Œ"></a>Registerå‡½æ•°	ç”¨æˆ·æ³¨å†Œ</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Register</span><span class="hljs-params">(req *RegisterRequest)</span></span> <span class="hljs-type">error</span> &#123;<br>	<span class="hljs-keyword">if</span> req.UserName == <span class="hljs-string">&quot;&quot;</span> || req.Password == <span class="hljs-string">&quot;&quot;</span> || req.Age &lt;= <span class="hljs-number">0</span> || !utils.Contains([]<span class="hljs-type">string</span>&#123;constant.GenderMale, constant.GenderFeMale&#125;, req.Gender) &#123;<br>		log.Errorf(<span class="hljs-string">&quot;register param invalid&quot;</span>)<br>		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;register param invalid&quot;</span>)<br>	&#125;<br>	existedUser, err := dao.GetUserByName(req.UserName)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;Register|%v&quot;</span>, err)<br>		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;register|%v&quot;</span>, err)<br>	&#125;<br>	<span class="hljs-keyword">if</span> existedUser != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;ç”¨æˆ·å·²ç»æ³¨å†Œ,user_name==%s&quot;</span>, req.UserName)<br>		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;ç”¨æˆ·å·²ç»æ³¨å†Œï¼Œä¸èƒ½é‡å¤æ³¨å†Œ&quot;</span>)<br>	&#125;<br><br>	user := &amp;model.User&#123;<br>		Name:     req.UserName,<br>		Age:      req.Age,<br>		Gender:   req.Gender,<br>		PassWord: req.Password,<br>		NickName: req.NickName,<br>		CreateModel: model.CreateModel&#123;<br>			Creator: req.UserName,<br>		&#125;,<br>		ModifyModel: model.ModifyModel&#123;<br>			Modifier: req.UserName,<br>		&#125;,<br>	&#125;<br>	log.Infof(<span class="hljs-string">&quot;user ====== %+v&quot;</span>, user)<br>	<span class="hljs-keyword">if</span> err := dao.CreateUser(user); err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;Register|%v&quot;</span>, err)<br>		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;register|%v&quot;</span>, err)<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¿™æ®µä»£ç å®ç°äº†ç”¨æˆ·æ³¨å†Œçš„åŠŸèƒ½ã€‚</p>
<p>â€‹	é¦–å…ˆï¼Œä»£ç ä¼šæ ¡éªŒè¯·æ±‚å‚æ•°çš„åˆæ³•æ€§ï¼Œå¦‚æœå‚æ•°æ— æ•ˆï¼Œåˆ™è¿”å›é”™è¯¯ä¿¡æ¯ã€‚æ¥ç€ï¼Œä»£ç ä¼šè°ƒç”¨<code>dao.GetUserByName</code>æ–¹æ³•æ¥æŸ¥è¯¢æ•°æ®åº“ä¸­æ˜¯å¦å·²ç»å­˜åœ¨äº†è¯¥ç”¨æˆ·åçš„ç”¨æˆ·ã€‚</p>
<ul>
<li>â€‹	å¦‚æœæŸ¥è¯¢å‡ºé”™ï¼Œåˆ™è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œ</li>
<li>â€‹	å¦‚æœæŸ¥è¯¢åˆ°å·²ç»å­˜åœ¨çš„ç”¨æˆ·ï¼Œåˆ™è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œæç¤ºç”¨æˆ·å·²ç»æ³¨å†Œã€‚	</li>
<li>â€‹	å¦‚æœæŸ¥è¯¢ç»“æœä¸ºç©ºï¼Œåˆ™è¯´æ˜è¯¥ç”¨æˆ·åå¯ä»¥æ³¨å†Œï¼Œä»£ç ä¼šæ ¹æ®è¯·æ±‚å‚æ•°æ„é€ ä¸€ä¸ªæ–°çš„<code>model.User</code>å¯¹è±¡ï¼Œå¹¶é€šè¿‡è°ƒç”¨<code>dao.CreateUser</code>æ–¹æ³•å°†ç”¨æˆ·ä¿¡æ¯æ’å…¥åˆ°æ•°æ®åº“ä¸­ã€‚<ul>
<li>å¦‚æœæ’å…¥å¤±è´¥ï¼Œåˆ™è¿”å›é”™è¯¯ä¿¡æ¯ã€‚</li>
<li>æœ€ç»ˆï¼Œå¦‚æœæ³¨å†ŒæˆåŠŸï¼Œåˆ™è¿”å›<code>nil</code>ï¼Œè¡¨ç¤ºæ²¡æœ‰é”™è¯¯ã€‚</li>
</ul>
</li>
</ul>
<h5 id=""><a href="#" class="headerlink" title=""></a></h5><h5 id="GetUserInfoå‡½æ•°-è·å–ç”¨æˆ·ä¿¡æ¯è¯·æ±‚ï¼Œ"><a href="#GetUserInfoå‡½æ•°-è·å–ç”¨æˆ·ä¿¡æ¯è¯·æ±‚ï¼Œ" class="headerlink" title="GetUserInfoå‡½æ•°	 è·å–ç”¨æˆ·ä¿¡æ¯è¯·æ±‚ï¼Œ"></a>GetUserInfoå‡½æ•°	 è·å–ç”¨æˆ·ä¿¡æ¯è¯·æ±‚ï¼Œ</h5><p>â€‹	åªèƒ½åœ¨ç”¨æˆ·ç™»é™†çš„æƒ…å†µä¸‹ä½¿ç”¨</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetUserInfo</span><span class="hljs-params">(ctx context.Context, req *GetUserInfoRequest)</span></span> (*GetUserInfoResponse, <span class="hljs-type">error</span>) &#123;<br>	uuid := ctx.Value(constant.ReqUuid)<br>	session := ctx.Value(constant.SessionKey).(<span class="hljs-type">string</span>)<br>	log.Infof(<span class="hljs-string">&quot;%s|GetUserInfo access from,user_name=%s|session=%s&quot;</span>, uuid, req.UserName, session)<br><br>	<span class="hljs-keyword">if</span> session == <span class="hljs-string">&quot;&quot;</span> || req.UserName == <span class="hljs-string">&quot;&quot;</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;GetUserInfo|request params invalid&quot;</span>)<br>	&#125;<br><br>	user, err := cache.GetSessionInfo(session)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;%s|Failed to get with session=%s|err =%v&quot;</span>, uuid, session, err)<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;getUserInfo|GetSessionInfo err:%v&quot;</span>, err)<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> user.Name != req.UserName &#123;<br>		log.Errorf(<span class="hljs-string">&quot;%s|session info not match with username=%s&quot;</span>, uuid, req.UserName)<br>	&#125;<br>	log.Infof(<span class="hljs-string">&quot;%s|Succ to GetUserInfo|user_name=%s|session=%s&quot;</span>, uuid, req.UserName, session)<br>	<span class="hljs-keyword">return</span> &amp;GetUserInfoResponse&#123;<br>		UserName: user.Name,<br>		Age:      user.Age,<br>		Gender:   user.Gender,<br>		PassWord: user.PassWord,<br>		NickName: user.NickName,<br>	&#125;, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¿™æ˜¯ä¸€ä¸ªè·å–ç”¨æˆ·ä¿¡æ¯çš„å‡½æ•°ã€‚</p>
<p>â€‹	å‡½æ•°ä½¿ç”¨äº†ä¸€ä¸ªä¸Šä¸‹æ–‡(Context)å¯¹è±¡æ¥ä¼ é€’è¯·æ±‚ä¿¡æ¯ã€‚å‡½æ•°æ¥æ”¶ä¸€ä¸ªåŒ…å«ç”¨æˆ·åçš„è¯·æ±‚(GetUserInfoRequest)å¹¶è¿”å›åŒ…å«ç”¨æˆ·ä¿¡æ¯çš„å“åº”(GetUserInfoResponse)ã€‚</p>
<p>â€‹	å‡½æ•°å…ˆä»ä¸Šä¸‹æ–‡ä¸­è·å–ç”¨æˆ·çš„sessionä¿¡æ¯ï¼Œç„¶åå†ä»ç¼“å­˜ä¸­è·å–ç”¨æˆ·çš„ä¿¡æ¯ã€‚</p>
<ul>
<li>â€‹	å¦‚æœsessionä¿¡æ¯å’Œè¯·æ±‚ä¸­çš„ç”¨æˆ·åä¸åŒ¹é…ï¼Œåˆ™å‡½æ•°ä¼šè®°å½•é”™è¯¯æ—¥å¿—ã€‚</li>
<li>â€‹	å¦‚æœè·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸï¼Œå‡½æ•°ä¼šè®°å½•æˆåŠŸæ—¥å¿—å¹¶è¿”å›åŒ…å«ç”¨æˆ·ä¿¡æ¯çš„å“åº”ã€‚</li>
<li>â€‹    å¦‚æœè¯·æ±‚å‚æ•°æ— æ•ˆï¼Œå‡½æ•°å°†è¿”å›é”™è¯¯ä¿¡æ¯ã€‚</li>
</ul>
<h5 id="getUserInfoå‡½æ•°"><a href="#getUserInfoå‡½æ•°" class="headerlink" title="getUserInfoå‡½æ•°"></a>getUserInfoå‡½æ•°</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getUserInfo</span><span class="hljs-params">(userName <span class="hljs-type">string</span>)</span></span> (*model.User, <span class="hljs-type">error</span>) &#123;<br>	user, err := cache.GetUserInfoFromCache(userName)<br>	<span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &amp;&amp; user.Name == userName &#123;<br>		log.Infof(<span class="hljs-string">&quot;cache_user ======= %v&quot;</span>, user)<br>		<span class="hljs-keyword">return</span> user, <span class="hljs-literal">nil</span><br>	&#125;<br><br>	user, err = dao.GetUserByName(userName)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> user, err<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> user == <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;ç”¨æˆ·å°šæœªæ³¨å†Œ&quot;</span>)<br>	&#125;<br>	log.Infof(<span class="hljs-string">&quot;user === %+v&quot;</span>, user)<br>	err = cache.SetUserCacheInfo(user)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Error(<span class="hljs-string">&quot;cache userinfo failed for user:&quot;</span>, user.Name, <span class="hljs-string">&quot; with err:&quot;</span>, err.Error())<br>	&#125;<br>	log.Infof(<span class="hljs-string">&quot;getUserInfo successfully, with key userinfo_%s&quot;</span>, user.Name)<br>	<span class="hljs-keyword">return</span> user, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¿™å‡½æ•°çš„è¾“å…¥å‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„ç”¨æˆ·åï¼Œè¿”å›ä¸€ä¸ªmodel.Userç±»å‹çš„ç»“æ„ä½“æŒ‡é’ˆå’Œä¸€ä¸ªé”™è¯¯ç±»å‹ã€‚</p>
<p>â€‹	å‡½æ•°çš„ä½œç”¨æ˜¯æ ¹æ®ç”¨æˆ·åä»ç¼“å­˜æˆ–æ•°æ®åº“ä¸­è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œ</p>
<ul>
<li>â€‹	å¦‚æœç”¨æˆ·ä¿¡æ¯å­˜åœ¨äºç¼“å­˜ä¸­ï¼Œåˆ™ç›´æ¥ä»ç¼“å­˜ä¸­è·å–ï¼Œ</li>
<li>â€‹	å¦åˆ™ä»æ•°æ®åº“ä¸­è·å–ã€‚<ul>
<li>å¦‚æœè·å–æˆåŠŸï¼Œå°†ä¼šå°†è·å–åˆ°çš„ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åœ¨ç¼“å­˜ä¸­ï¼Œå¹¶è¿”å›ç”¨æˆ·ä¿¡æ¯çš„æŒ‡é’ˆï¼Œ</li>
<li>å¦åˆ™è¿”å›é”™è¯¯ä¿¡æ¯ã€‚å¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰è¯¥ç”¨æˆ·åå¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯ï¼Œåˆ™è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯è¯´æ˜è¯¥ç”¨æˆ·å°šæœªæ³¨å†Œã€‚</li>
</ul>
</li>
</ul>
<h5 id="Loginå‡½æ•°ç”¨æˆ·ç™»å½•"><a href="#Loginå‡½æ•°ç”¨æˆ·ç™»å½•" class="headerlink" title="Loginå‡½æ•°	ç”¨æˆ·ç™»å½•"></a>Loginå‡½æ•°	ç”¨æˆ·ç™»å½•</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Login</span><span class="hljs-params">(ctx context.Context, req *LoginRequest)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br>	uuid := ctx.Value(constant.ReqUuid)<br>	log.Debugf(<span class="hljs-string">&quot; %s| Login access from:%s,@,%s&quot;</span>, uuid, req.UserName, req.PassWord)<br><br>	user, err := getUserInfo(req.UserName)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;Login|%v&quot;</span>, err)<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, fmt.Errorf(<span class="hljs-string">&quot;login|%v&quot;</span>, err)<br>	&#125;<br><br>	<span class="hljs-comment">// ç”¨æˆ·å­˜åœ¨</span><br>	<span class="hljs-keyword">if</span> req.PassWord != user.PassWord &#123;<br>		log.Errorf(<span class="hljs-string">&quot;Login|password err: req.password=%s|user.password=%s&quot;</span>, req.PassWord, user.PassWord)<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, fmt.Errorf(<span class="hljs-string">&quot;password is not correct&quot;</span>)<br>	&#125;<br><br>	session := utils.GenerateSession(user.Name)<br>	err = cache.SetSessionInfo(user, session)<br><br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot; Login|Failed to SetSessionInfo, uuid=%s|user_name=%s|session=%s|err=%v&quot;</span>, uuid, user.Name, session, err)<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, fmt.Errorf(<span class="hljs-string">&quot;login|SetSessionInfo fail:%v&quot;</span>, err)<br>	&#125;<br><br>	log.Infof(<span class="hljs-string">&quot;Login successfully, %s@%s with redis_session session_%s&quot;</span>, req.UserName, req.PassWord, session)<br>	<span class="hljs-keyword">return</span> session, <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™æ˜¯ä¸€ä¸ªå¤„ç†ç”¨æˆ·ç™»å½•çš„å‡½æ•°ã€‚</p>
<p>â€‹	å‡½æ•°æ¥æ”¶ä¸€ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡å’Œä¸€ä¸ªç™»å½•è¯·æ±‚å¯¹è±¡ã€‚å‡½æ•°é¦–å…ˆé€šè¿‡è°ƒç”¨getUserInfo()å‡½æ•°è·å–ç™»å½•è¯·æ±‚ä¸­çš„ç”¨æˆ·åå¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯ï¼Œ</p>
<ul>
<li>â€‹	å¦‚æœè·å–ç”¨æˆ·ä¿¡æ¯å‡ºé”™ï¼Œå‡½æ•°ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚</li>
<li>â€‹	å¦‚æœç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸï¼Œå‡½æ•°ä¼šæ£€æŸ¥ç”¨æˆ·è¾“å…¥çš„å¯†ç æ˜¯å¦ä¸è·å–çš„ç”¨æˆ·ä¿¡æ¯ä¸­çš„å¯†ç åŒ¹é…ï¼Œ<ul>
<li>å¦‚æœä¸åŒ¹é…ï¼Œåˆ™å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªå¯†ç ä¸æ­£ç¡®çš„é”™è¯¯ã€‚</li>
<li>å¦‚æœå¯†ç æ­£ç¡®ï¼Œåˆ™å‡½æ•°ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ session å¹¶å°†ç”¨æˆ·ä¿¡æ¯å’Œ session ç¼“å­˜åˆ° Redis ä¸­ï¼Œ<ul>
<li>å¦‚æœç¼“å­˜å‡ºé”™ï¼Œå‡½æ•°ä¹Ÿä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚</li>
<li>æœ€åï¼Œå‡½æ•°ä¼šè¿”å›æ–°ç”Ÿæˆçš„ sessionã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="Logout-é€€å‡ºç™»é™†"><a href="#Logout-é€€å‡ºç™»é™†" class="headerlink" title="Logout é€€å‡ºç™»é™†"></a>Logout é€€å‡ºç™»é™†</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Logout</span><span class="hljs-params">(ctx context.Context, req *LogoutRequest)</span></span> <span class="hljs-type">error</span> &#123;<br>	uuid := ctx.Value(constant.ReqUuid)<br>	session := ctx.Value(constant.SessionKey).(<span class="hljs-type">string</span>)<br>	log.Infof(<span class="hljs-string">&quot;%s|Logout access from,user_name=%s|session=%s&quot;</span>, uuid, req.UserName, session)<br>	<span class="hljs-comment">// è¦é€€å‡ºç™»å½•ï¼Œå¿…é¡»è¦æ˜¯åœ¨ç™»å½•æ€</span><br>	_, err := cache.GetSessionInfo(session)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;%s|Failed to get with session=%s|err =%v&quot;</span>, uuid, session, err)<br>		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;Logout|GetSessionInfo err:%v&quot;</span>, err)<br>	&#125;<br><br>	err = cache.DelSessionInfo(session)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;%s|Failed to delSessionInfo :%s&quot;</span>, uuid, session)<br>		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;del session err:%v&quot;</span>, err)<br>	&#125;<br>	log.Infof(<span class="hljs-string">&quot;%s|Success to delSessionInfo :%s&quot;</span>, uuid, session)<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç å®ç°äº†ç”¨æˆ·ç™»å‡ºçš„åŠŸèƒ½ã€‚</p>
<p>â€‹	å‡½æ•°ç­¾åä¸º<code>func Logout(ctx context.Context, req *LogoutRequest) error</code>ï¼Œæ¥æ”¶ä¸€ä¸ªä¸Šä¸‹æ–‡å’Œä¸€ä¸ªæ³¨é”€è¯·æ±‚ç»“æ„ä½“æŒ‡é’ˆï¼Œè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚</p>
<p>â€‹	å‡½æ•°é¦–å…ˆä»ä¸Šä¸‹æ–‡ä¸­è·å–ä¼šè¯ ID å’Œè¯·æ±‚å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç„¶åè°ƒç”¨<code>cache.GetSessionInfo(session)</code>æ–¹æ³•æ£€æŸ¥ä¼šè¯æ˜¯å¦å­˜åœ¨äºç¼“å­˜ä¸­ã€‚</p>
<ul>
<li>â€‹	å¦‚æœä¼šè¯ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›ä¸€ä¸ªé”™è¯¯ã€‚</li>
<li>â€‹	å¦åˆ™ï¼Œå®ƒå°†è°ƒç”¨<code>cache.DelSessionInfo(session)</code>æ–¹æ³•ä»ç¼“å­˜ä¸­åˆ é™¤ä¼šè¯ã€‚<ul>
<li>å¦‚æœåˆ é™¤å¤±è´¥ï¼Œåˆ™è¿”å›ä¸€ä¸ªé”™è¯¯ã€‚</li>
<li>å¦‚æœåˆ é™¤æˆåŠŸï¼Œåˆ™è¿”å›<code>nil</code>è¡¨ç¤ºæ“ä½œæˆåŠŸå®Œæˆã€‚</li>
</ul>
</li>
</ul>
<h5 id="updateUserInfoå‡½æ•°æ›´æ–°ç”¨æˆ·ä¿¡æ¯"><a href="#updateUserInfoå‡½æ•°æ›´æ–°ç”¨æˆ·ä¿¡æ¯" class="headerlink" title="updateUserInfoå‡½æ•°	æ›´æ–°ç”¨æˆ·ä¿¡æ¯"></a>updateUserInfoå‡½æ•°	æ›´æ–°ç”¨æˆ·ä¿¡æ¯</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">updateUserInfo</span><span class="hljs-params">(user *model.User, userName, session <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> &#123;<br>	affectedRows := dao.UpdateUserInfo(userName, user)<br><br>	<span class="hljs-comment">// dbæ›´æ–°æˆåŠŸ</span><br>	<span class="hljs-keyword">if</span> affectedRows == <span class="hljs-number">1</span> &#123;<br>		user, err := dao.GetUserByName(userName)<br>		<span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br>			cache.UpdateCachedUserInfo(user)<br>			<span class="hljs-keyword">if</span> session != <span class="hljs-string">&quot;&quot;</span> &#123;<br>				err = cache.SetSessionInfo(user, session)<br>				<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>					log.Error(<span class="hljs-string">&quot;update session failed:&quot;</span>, err.Error())<br>					cache.DelSessionInfo(session)<br>				&#125;<br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			log.Error(<span class="hljs-string">&quot;Failed to get dbUserInfo for cache, username=%s with err:&quot;</span>, userName, err.Error())<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¿™æ˜¯ä¸€ä¸ªæ›´æ–°ç”¨æˆ·ä¿¡æ¯çš„å‡½æ•°ã€‚</p>
<p>â€‹	å®ƒæ¥æ”¶ä¸€ä¸ª<code>model.User</code>ç±»å‹çš„æŒ‡é’ˆ<code>user</code>ï¼Œè¡¨ç¤ºè¦æ›´æ–°çš„ç”¨æˆ·ä¿¡æ¯ï¼Œä»¥åŠ<code>userName</code>å’Œ<code>session</code>ä¸¤ä¸ªå­—ç¬¦ä¸²ã€‚</p>
<ul>
<li>â€‹	å‡½æ•°é¦–å…ˆè°ƒç”¨<code>dao.UpdateUserInfo()</code>æ›´æ–°æ•°æ®åº“ä¸­è¯¥ç”¨æˆ·çš„ä¿¡æ¯ï¼Œ<ul>
<li>â€‹	å¦‚æœæˆåŠŸæ›´æ–°äº†ä¸€è¡Œï¼Œåˆ™è°ƒç”¨<code>dao.GetUserByName()</code>ä»æ•°æ®åº“ä¸­é‡æ–°è·å–è¯¥ç”¨æˆ·çš„ä¿¡æ¯ã€‚<ul>
<li>â€‹	å¦‚æœèƒ½å¤ŸæˆåŠŸè·å–ï¼Œåˆ™è°ƒç”¨<code>cache.UpdateCachedUserInfo()</code>æ›´æ–°ç¼“å­˜ä¸­çš„ç”¨æˆ·ä¿¡æ¯ã€‚<ul>
<li>â€‹	å¦‚æœä¼ å…¥çš„<code>session</code>å‚æ•°éç©ºï¼Œåˆ™è°ƒç”¨<code>cache.SetSessionInfo()</code>æ›´æ–°è¯¥ç”¨æˆ·çš„ä¼šè¯ä¿¡æ¯ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>â€‹	å¦‚æœå…¶ä¸­ä»»ä½•ä¸€ä¸ªæ­¥éª¤å¤±è´¥ï¼Œå‡½æ•°ä¼šæ‰“å°ç›¸åº”çš„é”™è¯¯æ—¥å¿—ï¼Œä½†ä»ç„¶ä¼šç»§ç»­æ‰§è¡Œå¹¶è¿”å›nilã€‚</li>
</ul>
</li>
</ul>
<h5 id="UpdateUserNickName-æ›´æ–°æ˜µç§°"><a href="#UpdateUserNickName-æ›´æ–°æ˜µç§°" class="headerlink" title="UpdateUserNickName æ›´æ–°æ˜µç§°"></a>UpdateUserNickName æ›´æ–°æ˜µç§°</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UpdateUserNickName</span><span class="hljs-params">(ctx context.Context, req *UpdateNickNameRequest)</span></span> <span class="hljs-type">error</span> &#123;<br>	uuid := ctx.Value(constant.ReqUuid)<br>	session := ctx.Value(constant.SessionKey).(<span class="hljs-type">string</span>)<br>	log.Infof(<span class="hljs-string">&quot;%s|UpdateUserNickName access from,user_name=%s|session=%s&quot;</span>, uuid, req.UserName, session)<br>	log.Infof(<span class="hljs-string">&quot;UpdateUserNickName|req==%v&quot;</span>, req)<br><br>	<span class="hljs-keyword">if</span> session == <span class="hljs-string">&quot;&quot;</span> || req.UserName == <span class="hljs-string">&quot;&quot;</span> &#123;<br>		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;UpdateUserNickName|request params invalid&quot;</span>)<br>	&#125;<br><br>	user, err := cache.GetSessionInfo(session)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;%s|Failed to get with session=%s|err =%v&quot;</span>, uuid, session, err)<br>		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;UpdateUserNickName|GetSessionInfo err:%v&quot;</span>, err)<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> user.Name != req.UserName &#123;<br>		log.Errorf(<span class="hljs-string">&quot;UpdateUserNickName|%s|session info not match with username=%s&quot;</span>, uuid, req.UserName)<br>	&#125;<br><br>	updateUser := &amp;model.User&#123;<br>		NickName: req.NewNickName,<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> updateUserInfo(updateUser, req.UserName, session)<br><br></code></pre></td></tr></table></figure>

<p>è¿™æ˜¯ä¸€ä¸ªç”¨äºæ›´æ–°ç”¨æˆ·æ˜µç§°çš„å‡½æ•°ã€‚</p>
<p>â€‹	å‡½æ•°æ¥æ”¶ä¸€ä¸ª context å¯¹è±¡å’Œä¸€ä¸ª UpdateNickNameRequest å¯¹è±¡ä½œä¸ºè¾“å…¥ï¼Œå¹¶è¿”å›ä¸€ä¸ªé”™è¯¯å¯¹è±¡ã€‚	å®ƒé¦–å…ˆä» context ä¸­è·å–è¯·æ±‚çš„ session ID å’Œè¯·æ±‚çš„ç”¨æˆ·åï¼Œç„¶åä½¿ç”¨è¿™äº›ä¿¡æ¯ä»ç¼“å­˜ä¸­è·å–ç”¨æˆ·ä¿¡æ¯ã€‚å¦‚æœè·å–è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œåˆ™å‡½æ•°è¿”å›ä¸€ä¸ªå¸¦æœ‰é”™è¯¯ä¿¡æ¯çš„é”™è¯¯å¯¹è±¡ã€‚</p>
<p>â€‹	æ¥ä¸‹æ¥ï¼Œå‡½æ•°æ£€æŸ¥ session ID å’Œç”¨æˆ·åæ˜¯å¦ä¸ºç©ºã€‚å¦‚æœæ˜¯ï¼Œåˆ™è¿”å›ä¸€ä¸ªé”™è¯¯å¯¹è±¡ï¼ŒæŒ‡ç¤ºè¯·æ±‚å‚æ•°æ— æ•ˆã€‚ç„¶åï¼Œå‡½æ•°æ£€æŸ¥ç¼“å­˜ä¸­è·å–çš„ç”¨æˆ·ä¿¡æ¯æ˜¯å¦ä¸è¯·æ±‚çš„ç”¨æˆ·åç›¸åŒ¹é…ã€‚</p>
<ul>
<li>â€‹	å¦‚æœä¸åŒ¹é…ï¼Œåˆ™å‡½æ•°è¿”å›ä¸€ä¸ªå¸¦æœ‰é”™è¯¯ä¿¡æ¯çš„é”™è¯¯å¯¹è±¡ã€‚</li>
<li>â€‹	å¦‚æœç”¨æˆ·ä¿¡æ¯ä¸è¯·æ±‚åŒ¹é…ï¼Œåˆ™å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ User å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«ç”¨æˆ·æ–°çš„æ˜µç§°ï¼Œå¹¶è°ƒç”¨ updateUserInfo å‡½æ•°æ¥æ›´æ–°ç¼“å­˜ä¸­çš„ç”¨æˆ·ä¿¡æ¯ã€‚<ul>
<li>å¦‚æœæ›´æ–°è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œåˆ™å‡½æ•°è¿”å›ä¸€ä¸ªå¸¦æœ‰é”™è¯¯ä¿¡æ¯çš„é”™è¯¯å¯¹è±¡ã€‚</li>
<li>å¦åˆ™ï¼Œå‡½æ•°è¿”å› nilï¼Œè¡¨ç¤ºæ›´æ–°æˆåŠŸã€‚</li>
</ul>
</li>
</ul>
<h5 id="å®Œæ•´ä»£ç -6"><a href="#å®Œæ•´ä»£ç -6" class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> service<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	log <span class="hljs-string">&quot;github.com/sirupsen/logrus&quot;</span><br>	<span class="hljs-string">&quot;golang.org/x/net/context&quot;</span><br>	<span class="hljs-string">&quot;user_system/internal/cache&quot;</span><br>	<span class="hljs-string">&quot;user_system/internal/dao&quot;</span><br>	<span class="hljs-string">&quot;user_system/internal/model&quot;</span><br>	<span class="hljs-string">&quot;user_system/pkg/constant&quot;</span><br>	<span class="hljs-string">&quot;user_system/utils&quot;</span><br>)<br><br><span class="hljs-comment">// Register ç”¨æˆ·æ³¨å†Œ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Register</span><span class="hljs-params">(req *RegisterRequest)</span></span> <span class="hljs-type">error</span> &#123;<br>	<span class="hljs-keyword">if</span> req.UserName == <span class="hljs-string">&quot;&quot;</span> || req.Password == <span class="hljs-string">&quot;&quot;</span> || req.Age &lt;= <span class="hljs-number">0</span> || !utils.Contains([]<span class="hljs-type">string</span>&#123;constant.GenderMale, constant.GenderFeMale&#125;, req.Gender) &#123;<br>		log.Errorf(<span class="hljs-string">&quot;register param invalid&quot;</span>)<br>		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;register param invalid&quot;</span>)<br>	&#125;<br>	existedUser, err := dao.GetUserByName(req.UserName)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;Register|%v&quot;</span>, err)<br>		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;register|%v&quot;</span>, err)<br>	&#125;<br>	<span class="hljs-keyword">if</span> existedUser != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;ç”¨æˆ·å·²ç»æ³¨å†Œ,user_name==%s&quot;</span>, req.UserName)<br>		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;ç”¨æˆ·å·²ç»æ³¨å†Œï¼Œä¸èƒ½é‡å¤æ³¨å†Œ&quot;</span>)<br>	&#125;<br><br>	user := &amp;model.User&#123;<br>		Name:     req.UserName,<br>		Age:      req.Age,<br>		Gender:   req.Gender,<br>		PassWord: req.Password,<br>		NickName: req.NickName,<br>		CreateModel: model.CreateModel&#123;<br>			Creator: req.UserName,<br>		&#125;,<br>		ModifyModel: model.ModifyModel&#123;<br>			Modifier: req.UserName,<br>		&#125;,<br>	&#125;<br>	log.Infof(<span class="hljs-string">&quot;user ====== %+v&quot;</span>, user)<br>	<span class="hljs-keyword">if</span> err := dao.CreateUser(user); err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;Register|%v&quot;</span>, err)<br>		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;register|%v&quot;</span>, err)<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// Login ç”¨æˆ·ç™»é™†</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Login</span><span class="hljs-params">(ctx context.Context, req *LoginRequest)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) &#123;<br>	uuid := ctx.Value(constant.ReqUuid)<br>	log.Debugf(<span class="hljs-string">&quot; %s| Login access from:%s,@,%s&quot;</span>, uuid, req.UserName, req.PassWord)<br><br>	user, err := getUserInfo(req.UserName)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;Login|%v&quot;</span>, err)<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, fmt.Errorf(<span class="hljs-string">&quot;login|%v&quot;</span>, err)<br>	&#125;<br><br>	<span class="hljs-comment">// ç”¨æˆ·å­˜åœ¨</span><br>	<span class="hljs-keyword">if</span> req.PassWord != user.PassWord &#123;<br>		log.Errorf(<span class="hljs-string">&quot;Login|password err: req.password=%s|user.password=%s&quot;</span>, req.PassWord, user.PassWord)<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, fmt.Errorf(<span class="hljs-string">&quot;password is not correct&quot;</span>)<br>	&#125;<br><br>	session := utils.GenerateSession(user.Name)<br>	err = cache.SetSessionInfo(user, session)<br><br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot; Login|Failed to SetSessionInfo, uuid=%s|user_name=%s|session=%s|err=%v&quot;</span>, uuid, user.Name, session, err)<br>		<span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>, fmt.Errorf(<span class="hljs-string">&quot;login|SetSessionInfo fail:%v&quot;</span>, err)<br>	&#125;<br><br>	log.Infof(<span class="hljs-string">&quot;Login successfully, %s@%s with redis_session session_%s&quot;</span>, req.UserName, req.PassWord, session)<br>	<span class="hljs-keyword">return</span> session, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// Logout é€€å‡ºç™»é™†</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Logout</span><span class="hljs-params">(ctx context.Context, req *LogoutRequest)</span></span> <span class="hljs-type">error</span> &#123;<br>	uuid := ctx.Value(constant.ReqUuid)<br>	session := ctx.Value(constant.SessionKey).(<span class="hljs-type">string</span>)<br>	log.Infof(<span class="hljs-string">&quot;%s|Logout access from,user_name=%s|session=%s&quot;</span>, uuid, req.UserName, session)<br>	<span class="hljs-comment">// è¦é€€å‡ºç™»å½•ï¼Œå¿…é¡»è¦æ˜¯åœ¨ç™»å½•æ€</span><br>	_, err := cache.GetSessionInfo(session)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;%s|Failed to get with session=%s|err =%v&quot;</span>, uuid, session, err)<br>		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;Logout|GetSessionInfo err:%v&quot;</span>, err)<br>	&#125;<br><br>	err = cache.DelSessionInfo(session)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;%s|Failed to delSessionInfo :%s&quot;</span>, uuid, session)<br>		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;del session err:%v&quot;</span>, err)<br>	&#125;<br>	log.Infof(<span class="hljs-string">&quot;%s|Success to delSessionInfo :%s&quot;</span>, uuid, session)<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// GetUserInfo è·å–ç”¨æˆ·ä¿¡æ¯è¯·æ±‚ï¼Œåªèƒ½åœ¨ç”¨æˆ·ç™»é™†çš„æƒ…å†µä¸‹ä½¿ç”¨</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetUserInfo</span><span class="hljs-params">(ctx context.Context, req *GetUserInfoRequest)</span></span> (*GetUserInfoResponse, <span class="hljs-type">error</span>) &#123;<br>	uuid := ctx.Value(constant.ReqUuid)<br>	session := ctx.Value(constant.SessionKey).(<span class="hljs-type">string</span>)<br>	log.Infof(<span class="hljs-string">&quot;%s|GetUserInfo access from,user_name=%s|session=%s&quot;</span>, uuid, req.UserName, session)<br><br>	<span class="hljs-keyword">if</span> session == <span class="hljs-string">&quot;&quot;</span> || req.UserName == <span class="hljs-string">&quot;&quot;</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;GetUserInfo|request params invalid&quot;</span>)<br>	&#125;<br><br>	user, err := cache.GetSessionInfo(session)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;%s|Failed to get with session=%s|err =%v&quot;</span>, uuid, session, err)<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;getUserInfo|GetSessionInfo err:%v&quot;</span>, err)<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> user.Name != req.UserName &#123;<br>		log.Errorf(<span class="hljs-string">&quot;%s|session info not match with username=%s&quot;</span>, uuid, req.UserName)<br>	&#125;<br>	log.Infof(<span class="hljs-string">&quot;%s|Succ to GetUserInfo|user_name=%s|session=%s&quot;</span>, uuid, req.UserName, session)<br>	<span class="hljs-keyword">return</span> &amp;GetUserInfoResponse&#123;<br>		UserName: user.Name,<br>		Age:      user.Age,<br>		Gender:   user.Gender,<br>		PassWord: user.PassWord,<br>		NickName: user.NickName,<br>	&#125;, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UpdateUserNickName</span><span class="hljs-params">(ctx context.Context, req *UpdateNickNameRequest)</span></span> <span class="hljs-type">error</span> &#123;<br>	uuid := ctx.Value(constant.ReqUuid)<br>	session := ctx.Value(constant.SessionKey).(<span class="hljs-type">string</span>)<br>	log.Infof(<span class="hljs-string">&quot;%s|UpdateUserNickName access from,user_name=%s|session=%s&quot;</span>, uuid, req.UserName, session)<br>	log.Infof(<span class="hljs-string">&quot;UpdateUserNickName|req==%v&quot;</span>, req)<br><br>	<span class="hljs-keyword">if</span> session == <span class="hljs-string">&quot;&quot;</span> || req.UserName == <span class="hljs-string">&quot;&quot;</span> &#123;<br>		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;UpdateUserNickName|request params invalid&quot;</span>)<br>	&#125;<br><br>	user, err := cache.GetSessionInfo(session)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;%s|Failed to get with session=%s|err =%v&quot;</span>, uuid, session, err)<br>		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">&quot;UpdateUserNickName|GetSessionInfo err:%v&quot;</span>, err)<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> user.Name != req.UserName &#123;<br>		log.Errorf(<span class="hljs-string">&quot;UpdateUserNickName|%s|session info not match with username=%s&quot;</span>, uuid, req.UserName)<br>	&#125;<br><br>	updateUser := &amp;model.User&#123;<br>		NickName: req.NewNickName,<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> updateUserInfo(updateUser, req.UserName, session)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getUserInfo</span><span class="hljs-params">(userName <span class="hljs-type">string</span>)</span></span> (*model.User, <span class="hljs-type">error</span>) &#123;<br>	user, err := cache.GetUserInfoFromCache(userName)<br>	<span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &amp;&amp; user.Name == userName &#123;<br>		log.Infof(<span class="hljs-string">&quot;cache_user ======= %v&quot;</span>, user)<br>		<span class="hljs-keyword">return</span> user, <span class="hljs-literal">nil</span><br>	&#125;<br><br>	user, err = dao.GetUserByName(userName)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> user, err<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> user == <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">&quot;ç”¨æˆ·å°šæœªæ³¨å†Œ&quot;</span>)<br>	&#125;<br>	log.Infof(<span class="hljs-string">&quot;user === %+v&quot;</span>, user)<br>	err = cache.SetUserCacheInfo(user)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Error(<span class="hljs-string">&quot;cache userinfo failed for user:&quot;</span>, user.Name, <span class="hljs-string">&quot; with err:&quot;</span>, err.Error())<br>	&#125;<br>	log.Infof(<span class="hljs-string">&quot;getUserInfo successfully, with key userinfo_%s&quot;</span>, user.Name)<br>	<span class="hljs-keyword">return</span> user, <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">updateUserInfo</span><span class="hljs-params">(user *model.User, userName, session <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> &#123;<br>	affectedRows := dao.UpdateUserInfo(userName, user)<br><br>	<span class="hljs-comment">// dbæ›´æ–°æˆåŠŸ</span><br>	<span class="hljs-keyword">if</span> affectedRows == <span class="hljs-number">1</span> &#123;<br>		user, err := dao.GetUserByName(userName)<br>		<span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> &#123;<br>			cache.UpdateCachedUserInfo(user)<br>			<span class="hljs-keyword">if</span> session != <span class="hljs-string">&quot;&quot;</span> &#123;<br>				err = cache.SetSessionInfo(user, session)<br>				<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>					log.Error(<span class="hljs-string">&quot;update session failed:&quot;</span>, err.Error())<br>					cache.DelSessionInfo(session)<br>				&#125;<br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			log.Error(<span class="hljs-string">&quot;Failed to get dbUserInfo for cache, username=%s with err:&quot;</span>, userName, err.Error())<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="ï¼ˆ5ï¼‰cache"><a href="#ï¼ˆ5ï¼‰cache" class="headerlink" title="ï¼ˆ5ï¼‰cache"></a>ï¼ˆ5ï¼‰cache</h3><h5 id="GetUserInfoFromCache"><a href="#GetUserInfoFromCache" class="headerlink" title="GetUserInfoFromCache"></a>GetUserInfoFromCache</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetUserInfoFromCache</span><span class="hljs-params">(username <span class="hljs-type">string</span>)</span></span> (*model.User, <span class="hljs-type">error</span>) &#123;<br>	redisKey := constant.UserInfoPrefix + username<br>	val, err := utils.GetRedisCli().Get(context.Background(), redisKey).Result()<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br>	user := &amp;model.User&#123;&#125;<br>	err = json.Unmarshal([]<span class="hljs-type">byte</span>(val), user)<br>	<span class="hljs-keyword">return</span> user, err<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¯¥å‡½æ•°æ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„å‚æ•° <code>username</code>ï¼Œå¹¶è¿”å›ä¸€ä¸ªæŒ‡å‘ <code>model.User</code> ç»“æ„ä½“çš„æŒ‡é’ˆå’Œä¸€ä¸ªé”™è¯¯å¯¹è±¡ã€‚</p>
<p>â€‹	åœ¨å‡½æ•°å†…éƒ¨ï¼Œé¦–å…ˆä½¿ç”¨ç»™å®šçš„ <code>username</code> æ„é€  Redis çš„ keyï¼Œç„¶åä½¿ç”¨ Redis å®¢æˆ·ç«¯åº“çš„ <code>Get</code> æ–¹æ³•ä» Redis ä¸­è·å–å¯¹åº”çš„å€¼ã€‚</p>
<ul>
<li>â€‹	å¦‚æœæ“ä½œ Redis è¿‡ç¨‹ä¸­å‡ºç°äº†é”™è¯¯ï¼Œå‡½æ•°ä¼šè¿”å›ä¸€ä¸ª <code>nil</code> æŒ‡é’ˆå’Œè¯¥é”™è¯¯å¯¹è±¡ã€‚</li>
<li>â€‹	å¦‚æœè·å–åˆ°äº† Redis ä¸­å­˜å‚¨çš„å€¼ï¼Œå‡½æ•°ä¼šå®šä¹‰ä¸€ä¸ª <code>model.User</code> ç±»å‹çš„æŒ‡é’ˆ <code>user</code>ï¼Œå¹¶ä½¿ç”¨ <code>json.Unmarshal</code> æ–¹æ³•å°† Redis ä¸­çš„å€¼è§£ç æˆ <code>user</code> å¯¹è±¡ã€‚</li>
<li>æœ€åï¼Œå‡½æ•°è¿”å› <code>user</code> æŒ‡é’ˆå’Œä»»ä½•åœ¨è§£ç è¿‡ç¨‹ä¸­å‡ºç°çš„é”™è¯¯ã€‚</li>
</ul>
<h5 id="SetUserCacheInfo"><a href="#SetUserCacheInfo" class="headerlink" title="SetUserCacheInfo"></a>SetUserCacheInfo</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SetUserCacheInfo</span><span class="hljs-params">(user *model.User)</span></span> <span class="hljs-type">error</span> &#123;<br>	redisKey := constant.UserInfoPrefix + user.Name<br>	val, err := json.Marshal(user)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>	expired := time.Second * time.Duration(config.GetGlobalConf().Cache.UserExpired)<br>	_, err = utils.GetRedisCli().Set(context.Background(), redisKey, val, expired*time.Second).Result()<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å‡½æ•°æ¥å—ä¸€ä¸ªæŒ‡å‘ <code>model.User</code> ç±»å‹çš„æŒ‡é’ˆä½œä¸ºå‚æ•°ï¼Œå¹¶è¿”å›ä¸€ä¸ª <code>error</code> ç±»å‹çš„é”™è¯¯ã€‚å‡½æ•°ä¸»è¦åšäº†ä»¥ä¸‹äº‹æƒ…ï¼š</p>
<ol>
<li>æ ¹æ®ä¼ å…¥çš„ <code>user</code> æŒ‡é’ˆç”Ÿæˆ Redis çš„é”®åï¼Œé”®åæ ¼å¼ä¸º <code>constant.UserInfoPrefix + user.Name</code>ã€‚</li>
<li>å°† <code>user</code> å¯¹è±¡è½¬æ¢ä¸º JSON æ ¼å¼çš„å­—ç¬¦ä¸²ã€‚</li>
<li>æ ¹æ®å…¨å±€é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼Œä¸º <code>redisKey</code> å¯¹åº”çš„é”®è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚</li>
<li>å°†è½¬æ¢åçš„ JSON å­—ç¬¦ä¸²ä¸ Redis ä¸­çš„é”® <code>redisKey</code> ä¸€èµ·å­˜å…¥ Redis ä¸­ã€‚å¦‚æœå­˜å‚¨æˆåŠŸï¼Œåˆ™è¿”å› <code>nil</code>ï¼Œå¦åˆ™è¿”å› <code>error</code>ã€‚</li>
</ol>
<h5 id="UpdateCachedUserInfo"><a href="#UpdateCachedUserInfo" class="headerlink" title="UpdateCachedUserInfo"></a>UpdateCachedUserInfo</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UpdateCachedUserInfo</span><span class="hljs-params">(user *model.User)</span></span> <span class="hljs-type">error</span> &#123;<br>	err := SetUserCacheInfo(user)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		redisKey := constant.UserInfoPrefix + user.Name<br>		utils.GetRedisCli().Del(context.Background(), redisKey).Result()<br>	&#125;<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¯¥å‡½æ•°çš„ä½œç”¨æ˜¯æ›´æ–°ç¼“å­˜ä¸­ç”¨æˆ·ä¿¡æ¯ã€‚</p>
<ul>
<li>â€‹	é¦–å…ˆè°ƒç”¨<code>SetUserCacheInfo</code>å°è¯•å°†ç”¨æˆ·ä¿¡æ¯å†™å…¥ç¼“å­˜ä¸­ï¼Œ</li>
<li>â€‹	å¦‚æœå†™å…¥å¤±è´¥ï¼Œåˆ™åˆ é™¤ç¼“å­˜ä¸­å·²å­˜åœ¨çš„ç”¨æˆ·ä¿¡æ¯ã€‚</li>
<li>â€‹	æ— è®ºå†™å…¥æ˜¯å¦æˆåŠŸï¼Œæœ€åéƒ½ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ï¼ˆnilæˆ–è€…é”™è¯¯ä¿¡æ¯ï¼‰ã€‚</li>
</ul>
<h5 id="SetSessionInfo"><a href="#SetSessionInfo" class="headerlink" title="SetSessionInfo"></a>SetSessionInfo</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SetSessionInfo</span><span class="hljs-params">(user *model.User, session <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> &#123;<br>	redisKey := constant.SessionKeyPrefix + session<br>	val, err := json.Marshal(&amp;user)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>	expired := time.Second * time.Duration(config.GetGlobalConf().Cache.SessionExpired)<br>	_, err = utils.GetRedisCli().Set(context.Background(), redisKey, val, expired*time.Second).Result()<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	 <code>SetSessionInfo</code>å‡½æ•°ç”¨äºå°†ç”¨æˆ·ä¿¡æ¯å’Œ session ID å­˜å‚¨åœ¨ Redis ä¸­ï¼Œä»¥ä¾¿åç»­çš„ç”¨æˆ·ç™»å½•å’Œèº«ä»½éªŒè¯ã€‚</p>
<p>â€‹	å®ƒæ¥å—ä¸€ä¸ª <code>model.User</code> ç±»å‹çš„ç”¨æˆ·å¯¹è±¡å’Œä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„ session ID ä½œä¸ºå‚æ•°ã€‚å®ƒå°†ç”¨æˆ·å¯¹è±¡ç¼–ç ä¸º JSON å­—ç¬¦ä¸²ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨ Redis æ•°æ®åº“ä¸­ã€‚</p>
<p>â€‹	å‡½æ•°é¦–å…ˆé€šè¿‡ Redis key çš„å‰ç¼€å’Œ session ID ç”Ÿæˆå®Œæ•´çš„ Redis keyï¼Œç„¶åä½¿ç”¨ Redis å®¢æˆ·ç«¯çš„ <code>Set</code> æ–¹æ³•å°†ç¼–ç åçš„ç”¨æˆ·å¯¹è±¡å­˜å‚¨åœ¨ Redis ä¸­ï¼ŒåŒæ—¶è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚æœ€åï¼Œå‡½æ•°è¿”å›å¯èƒ½å‡ºç°çš„é”™è¯¯ã€‚</p>
<h5 id="GetSessionInfo"><a href="#GetSessionInfo" class="headerlink" title="GetSessionInfo"></a>GetSessionInfo</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetSessionInfo</span><span class="hljs-params">(session <span class="hljs-type">string</span>)</span></span> (*model.User, <span class="hljs-type">error</span>) &#123;<br>	redisKey := constant.SessionKeyPrefix + session<br>	val, err := utils.GetRedisCli().Get(context.Background(), redisKey).Result()<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br>	user := &amp;model.User&#123;&#125;<br>	err = json.Unmarshal([]<span class="hljs-type">byte</span>(val), &amp;user)<br>	<span class="hljs-keyword">return</span> user, err<br>&#125;<br></code></pre></td></tr></table></figure>

<p> <code>GetSessionInfo</code> çš„è¾“å…¥å‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸² <code>session</code>ï¼Œè¡¨ç¤ºç”¨æˆ·çš„ session idã€‚</p>
<p> è¿™ä¸ªå‡½æ•°çš„åŠŸèƒ½æ˜¯ä» Redis ä¸­è·å–ä¿å­˜åœ¨è¯¥ session id å¯¹åº”çš„å€¼ï¼Œå¹¶å°†å…¶ååºåˆ—åŒ–æˆä¸€ä¸ª <code>model.User</code> ç»“æ„ä½“å¹¶è¿”å›ã€‚</p>
<p> å…·ä½“å®ç°ä¸­ï¼Œè¯¥å‡½æ•°å…ˆå°† session id æ‹¼æ¥ä¸Šä¸€ä¸ªå›ºå®šçš„å‰ç¼€ï¼Œå¾—åˆ°ä¸€ä¸ª Redis keyï¼Œç„¶åé€šè¿‡ <code>utils.GetRedisCli().Get()</code> å‡½æ•°ä» Redis ä¸­è·å–è¯¥ key å¯¹åº”çš„å€¼ã€‚</p>
<p> è·å–åˆ°å€¼åï¼Œä½¿ç”¨ <code>json.Unmarshal()</code> å‡½æ•°å°†å…¶ååºåˆ—åŒ–æˆä¸€ä¸ª <code>model.User</code> ç»“æ„ä½“ï¼Œæœ€ç»ˆå°†è¯¥ç»“æ„ä½“å’Œå¯èƒ½å­˜åœ¨çš„é”™è¯¯ä¸€åŒè¿”å›ã€‚</p>
<h5 id="DelSessionInfo"><a href="#DelSessionInfo" class="headerlink" title="DelSessionInfo"></a>DelSessionInfo</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DelSessionInfo</span><span class="hljs-params">(session <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> &#123;<br>	redisKey := constant.SessionKeyPrefix + session<br>	_, err := utils.GetRedisCli().Del(context.Background(), redisKey).Result()<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>	DelSessionInfo</code> 	æ¥å—ä¸€ä¸ª <code>session</code> å­—ç¬¦ä¸²å‚æ•°ï¼Œè¯¥å‚æ•°æ˜¯ä¼šè¯ IDï¼Œç”¨äºä» Redis ä¸­åˆ é™¤å­˜å‚¨çš„ç”¨æˆ·ä¼šè¯ä¿¡æ¯ã€‚</p>
<p>â€‹	å‡½æ•°ä½¿ç”¨ <code>constant.SessionKeyPrefix</code> å¸¸é‡å’Œ <code>session</code> å­—ç¬¦ä¸²å‚æ•°ç»„åˆæˆ Redis ä¸­çš„é”®å€¼ï¼Œç„¶åä½¿ç”¨ <code>utils.GetRedisCli().Del()</code> æ–¹æ³•ä» Redis ä¸­åˆ é™¤è¯¥é”®å€¼ï¼Œå¹¶è¿”å›é”™è¯¯ã€‚</p>
<p>â€‹	å¦‚æœé”®å€¼åœ¨ Redis ä¸­ä¸å­˜åœ¨ï¼Œ<code>Del()</code> æ–¹æ³•å°†è¿”å›ä¸€ä¸ª <code>nil</code> çš„ç»“æœï¼Œä½†ä¸ä¼šè¿”å›é”™è¯¯ã€‚</p>
<h5 id="å®Œæ•´ä»£ç -7"><a href="#å®Œæ•´ä»£ç -7" class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> cache<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;encoding/json&quot;</span><br>	<span class="hljs-string">&quot;golang.org/x/net/context&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>	<span class="hljs-string">&quot;user_system/config&quot;</span><br>	<span class="hljs-string">&quot;user_system/internal/model&quot;</span><br>	<span class="hljs-string">&quot;user_system/pkg/constant&quot;</span><br>	<span class="hljs-string">&quot;user_system/utils&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetUserInfoFromCache</span><span class="hljs-params">(username <span class="hljs-type">string</span>)</span></span> (*model.User, <span class="hljs-type">error</span>) &#123;<br>	redisKey := constant.UserInfoPrefix + username<br>	val, err := utils.GetRedisCli().Get(context.Background(), redisKey).Result()<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br>	user := &amp;model.User&#123;&#125;<br>	err = json.Unmarshal([]<span class="hljs-type">byte</span>(val), user)<br>	<span class="hljs-keyword">return</span> user, err<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SetUserCacheInfo</span><span class="hljs-params">(user *model.User)</span></span> <span class="hljs-type">error</span> &#123;<br>	redisKey := constant.UserInfoPrefix + user.Name<br>	val, err := json.Marshal(user)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>	expired := time.Second * time.Duration(config.GetGlobalConf().Cache.UserExpired)<br>	_, err = utils.GetRedisCli().Set(context.Background(), redisKey, val, expired*time.Second).Result()<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UpdateCachedUserInfo</span><span class="hljs-params">(user *model.User)</span></span> <span class="hljs-type">error</span> &#123;<br>	err := SetUserCacheInfo(user)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		redisKey := constant.UserInfoPrefix + user.Name<br>		utils.GetRedisCli().Del(context.Background(), redisKey).Result()<br>	&#125;<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetSessionInfo</span><span class="hljs-params">(session <span class="hljs-type">string</span>)</span></span> (*model.User, <span class="hljs-type">error</span>) &#123;<br>	redisKey := constant.SessionKeyPrefix + session<br>	val, err := utils.GetRedisCli().Get(context.Background(), redisKey).Result()<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err<br>	&#125;<br>	user := &amp;model.User&#123;&#125;<br>	err = json.Unmarshal([]<span class="hljs-type">byte</span>(val), &amp;user)<br>	<span class="hljs-keyword">return</span> user, err<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SetSessionInfo</span><span class="hljs-params">(user *model.User, session <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> &#123;<br>	redisKey := constant.SessionKeyPrefix + session<br>	val, err := json.Marshal(&amp;user)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		<span class="hljs-keyword">return</span> err<br>	&#125;<br>	expired := time.Second * time.Duration(config.GetGlobalConf().Cache.SessionExpired)<br>	_, err = utils.GetRedisCli().Set(context.Background(), redisKey, val, expired*time.Second).Result()<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">DelSessionInfo</span><span class="hljs-params">(session <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> &#123;<br>	redisKey := constant.SessionKeyPrefix + session<br>	_, err := utils.GetRedisCli().Del(context.Background(), redisKey).Result()<br>	<span class="hljs-keyword">return</span> err<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="3ã€apiåŒ…"><a href="#3ã€apiåŒ…" class="headerlink" title="3ã€apiåŒ…"></a>3ã€apiåŒ…</h2><h3 id="ï¼ˆ1ï¼‰v1"><a href="#ï¼ˆ1ï¼‰v1" class="headerlink" title="ï¼ˆ1ï¼‰v1"></a>ï¼ˆ1ï¼‰v1</h3><h4 id="â‘ api-goåŒ…"><a href="#â‘ api-goåŒ…" class="headerlink" title="â‘ 	api.goåŒ…"></a>â‘ 	api.goåŒ…</h4><h5 id="Pingå‡½æ•°å¥åº·æ£€æŸ¥"><a href="#Pingå‡½æ•°å¥åº·æ£€æŸ¥" class="headerlink" title="Pingå‡½æ•°	å¥åº·æ£€æŸ¥"></a>Pingå‡½æ•°	å¥åº·æ£€æŸ¥</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Ping</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>	appConfig := config.GetGlobalConf().AppConfig<br>	confInfo, _ := json.MarshalIndent(appConfig, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;  &quot;</span>)<br>	appInfo := fmt.Sprintf(<span class="hljs-string">&quot;app_name: %s\nversion: %s\n\n%s&quot;</span>, appConfig.AppName, appConfig.Version,<br>		<span class="hljs-type">string</span>(confInfo))<br>	c.String(http.StatusOK, appInfo)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¿™æ˜¯ä¸€ä¸ªå¤„ç†HTTPè¯·æ±‚çš„å¤„ç†å‡½æ•°ï¼Œå‡½æ•°åä¸º <code>Ping</code>ï¼Œæ¥å—ä¸€ä¸ª <code>*gin.Context</code> ç±»å‹çš„å‚æ•° <code>c</code>ã€‚</p>
<p>â€‹	å‡½æ•°é€šè¿‡ <code>config.GetGlobalConf()</code> è·å–å…¨å±€é…ç½®ï¼Œç„¶åå°†å…¶è½¬æ¢ä¸º JSON æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œå¹¶ä½¿ç”¨ <code>c.String()</code> è¿”å›ç»™å®¢æˆ·ç«¯ã€‚å…¶ä¸­ï¼Œè¿”å›å­—ç¬¦ä¸²åŒ…å«äº†åº”ç”¨çš„åç§°ã€ç‰ˆæœ¬å’Œå…¨å±€é…ç½®ä¿¡æ¯ã€‚</p>
<p>â€‹	è¿™æ®µä»£ç çš„ä¸»è¦ä½œç”¨æ˜¯åœ¨æœåŠ¡å¯åŠ¨åæä¾›ä¸€ä¸ªå¥åº·æ£€æŸ¥çš„æ¥å£ï¼Œç”¨äºç¡®è®¤æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œä»¥åŠæŸ¥çœ‹åº”ç”¨çš„ç‰ˆæœ¬å’Œé…ç½®ä¿¡æ¯ã€‚</p>
<h5 id="Register-æ³¨å†Œ"><a href="#Register-æ³¨å†Œ" class="headerlink" title="Register æ³¨å†Œ"></a>Register æ³¨å†Œ</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Register</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>	req := &amp;service.RegisterRequest&#123;&#125;<br>	rsp := &amp;HttpResponse&#123;&#125;<br>	err := c.ShouldBindJSON(&amp;req)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;request json err %v&quot;</span>, err)<br>		rsp.ResponseWithError(c, CodeBodyBindErr, err.Error())<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-keyword">if</span> err := service.Register(req); err != <span class="hljs-literal">nil</span> &#123;<br>		rsp.ResponseWithError(c, CodeRegisterErr, err.Error())<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	rsp.ResponseSuccess(c)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¯¥å‡½æ•°æ˜¯ä¸€ä¸ªHTTPå¤„ç†å‡½æ•°ï¼Œç”¨äºå¤„ç†ç”¨æˆ·æ³¨å†Œè¯·æ±‚ã€‚</p>
<p>â€‹	é¦–å…ˆä»HTTPè¯·æ±‚ä¸­è§£æå‡ºRegisterRequestå¯¹è±¡ã€‚</p>
<ul>
<li>â€‹	å¦‚æœè§£æå‡ºé”™ï¼Œå°†è¿”å›HTTPçŠ¶æ€ç ä¸ºCodeBodyBindErrçš„é”™è¯¯å“åº”ã€‚</li>
<li>â€‹	å¦åˆ™ï¼Œå°†è°ƒç”¨service.Registerå‡½æ•°è¿›è¡Œæ³¨å†Œã€‚<ul>
<li>å¦‚æœæ³¨å†Œå¤±è´¥ï¼Œå°†è¿”å›HTTPçŠ¶æ€ç ä¸ºCodeRegisterErrçš„é”™è¯¯å“åº”ã€‚</li>
<li>å¦‚æœæ³¨å†ŒæˆåŠŸï¼Œåˆ™è¿”å›HTTPçŠ¶æ€ç ä¸ºCodeSuccessçš„æˆåŠŸå“åº”ã€‚</li>
</ul>
</li>
</ul>
<h5 id="Login-ç™»å½•"><a href="#Login-ç™»å½•" class="headerlink" title="Login ç™»å½•"></a>Login ç™»å½•</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Login</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>   req := &amp;service.LoginRequest&#123;&#125;<br>   rsp := &amp;HttpResponse&#123;&#125;<br>   err := c.ShouldBindJSON(&amp;req)<br>   <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>      log.Errorf(<span class="hljs-string">&quot;request json err %v&quot;</span>, err)<br>      rsp.ResponseWithError(c, CodeBodyBindErr, err.Error())<br>      <span class="hljs-keyword">return</span><br>   &#125;<br><br>   uuid := utils.Md5String(req.UserName + time.Now().GoString())<br>   ctx := context.WithValue(context.Background(), <span class="hljs-string">&quot;uuid&quot;</span>, uuid)<br>   log.Infof(<span class="hljs-string">&quot;loggin start,user:%s, password:%s&quot;</span>, req.UserName, req.PassWord)<br>   session, err := service.Login(ctx, req)<br>   <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>      rsp.ResponseWithError(c, CodeLoginErr, err.Error())<br>      <span class="hljs-keyword">return</span><br>   &#125;<br>   <span class="hljs-comment">// ç™»é™†æˆåŠŸï¼Œè®¾ç½®cookie</span><br>   c.SetCookie(constant.SessionKey, session, constant.CookieExpire, <span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>)<br>   rsp.ResponseSuccess(c)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	å®ç°äº†ä¸€ä¸ªç™»å½•æ¥å£ï¼Œæ¥å—å‰ç«¯ä¼ æ¥çš„ç™»å½•è¯·æ±‚æ•°æ®ï¼Œç„¶åè°ƒç”¨ <code>service.Login</code> å‡½æ•°æ¥è¿›è¡Œç™»å½•æ ¡éªŒï¼Œ</p>
<ul>
<li>â€‹	å¦‚æœç™»å½•æˆåŠŸï¼Œåˆ™åœ¨å“åº”ä¸­è®¾ç½®ä¸€ä¸ªåä¸º <code>session</code> çš„ cookieã€‚</li>
<li>â€‹	å¦‚æœå‰ç«¯ä¼ æ¥çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œåˆ™è¿”å›é”™è¯¯ç  <code>CodeBodyBindErr</code>ã€‚<ul>
<li>å¦‚æœç™»å½•å¤±è´¥ï¼Œåˆ™è¿”å›é”™è¯¯ç  <code>CodeLoginErr</code>ã€‚</li>
<li>åœ¨ç™»å½•çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜ä½¿ç”¨äº†ä¸€ä¸ª <code>uuid</code> ä½œä¸º <code>ctx</code> çš„å€¼è¿›è¡Œäº†ä¸Šä¸‹æ–‡ä¼ é€’ã€‚</li>
</ul>
</li>
</ul>
<h5 id="Logout-ç™»å‡º"><a href="#Logout-ç™»å‡º" class="headerlink" title="Logout ç™»å‡º"></a>Logout ç™»å‡º</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Logout</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>	session, _ := c.Cookie(constant.SessionKey)<br>	ctx := context.WithValue(context.Background(), constant.SessionKey, session)<br>	req := &amp;service.LogoutRequest&#123;&#125;<br>	rsp := &amp;HttpResponse&#123;&#125;<br>	err := c.ShouldBindJSON(req)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;bind get logout request json err %v&quot;</span>, err)<br>		rsp.ResponseWithError(c, CodeBodyBindErr, err.Error())<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	uuid := utils.Md5String(req.UserName + time.Now().GoString())<br>	ctx = context.WithValue(ctx, <span class="hljs-string">&quot;uuid&quot;</span>, uuid)<br>	<span class="hljs-keyword">if</span> err := service.Logout(ctx, req); err != <span class="hljs-literal">nil</span> &#123;<br>		rsp.ResponseWithError(c, CodeLogoutErr, err.Error())<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	c.SetCookie(constant.SessionKey, session, <span class="hljs-number">-1</span>, <span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>)<br>	rsp.ResponseSuccess(c)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¿™æ˜¯ä¸€ä¸ªç”¨äºå¤„ç†ç”¨æˆ·ç™»å‡ºè¯·æ±‚çš„å‡½æ•°ï¼Œé€šè¿‡è°ƒç”¨serviceå±‚çš„Logoutæ–¹æ³•æ¥å®Œæˆç”¨æˆ·çš„ç™»å‡ºæ“ä½œã€‚</p>
<p>â€‹	å‡½æ•°é¦–å…ˆä»è¯·æ±‚ä¸­è·å–ç”¨æˆ·åå’Œsessionï¼Œå¹¶å°†sessionä¿å­˜åœ¨ä¸Šä¸‹æ–‡ä¸­ã€‚</p>
<p>â€‹	ç„¶åï¼Œè§£æè¯·æ±‚å¹¶å°†å…¶ç»‘å®šåˆ°ä¸€ä¸ªLogoutRequestç»“æ„ä½“ä¸­ã€‚</p>
<p>â€‹	æ¥ä¸‹æ¥ï¼Œä½¿ç”¨è¯¥ç»“æ„ä½“è°ƒç”¨serviceå±‚çš„Logoutæ–¹æ³•ï¼Œå¹¶å°†ç”Ÿæˆçš„å”¯ä¸€æ ‡è¯†ç¬¦(uuid)å’Œä¸Šä¸‹æ–‡ä¸€èµ·ä¼ é€’ã€‚</p>
<ul>
<li>â€‹	å¦‚æœç™»å‡ºæ“ä½œæˆåŠŸï¼Œå‡½æ•°ä¼šå°†ç”¨æˆ·çš„session cookieè®¾ç½®ä¸ºè¿‡æœŸï¼Œå¹¶è¿”å›æˆåŠŸå“åº”ã€‚</li>
<li>â€‹	å¦‚æœæœ‰é”™è¯¯å‘ç”Ÿï¼Œå‡½æ•°ä¼šè¿”å›é”™è¯¯å“åº”ã€‚</li>
</ul>
<h5 id="GetUserInfo-è·å–ç”¨æˆ·ä¿¡æ¯"><a href="#GetUserInfo-è·å–ç”¨æˆ·ä¿¡æ¯" class="headerlink" title="GetUserInfo è·å–ç”¨æˆ·ä¿¡æ¯"></a>GetUserInfo è·å–ç”¨æˆ·ä¿¡æ¯</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetUserInfo</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>	userName := c.Query(<span class="hljs-string">&quot;username&quot;</span>)<br>	session, _ := c.Cookie(constant.SessionKey)<br>	ctx := context.WithValue(context.Background(), constant.SessionKey, session)<br>	req := &amp;service.GetUserInfoRequest&#123;<br>		UserName: userName,<br>	&#125;<br>	rsp := &amp;HttpResponse&#123;&#125;<br>	uuid := utils.Md5String(req.UserName + time.Now().GoString())<br>	ctx = context.WithValue(ctx, <span class="hljs-string">&quot;uuid&quot;</span>, uuid)<br>	userInfo, err := service.GetUserInfo(ctx, req)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		rsp.ResponseWithError(c, CodeGetUserInfoErr, err.Error())<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	rsp.ResponseWithData(c, userInfo)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨Ginæ¡†æ¶ç¼–å†™çš„è·å–ç”¨æˆ·ä¿¡æ¯çš„APIå¤„ç†å‡½æ•°ã€‚</p>
<p>â€‹	å®ƒé¦–å…ˆä»HTTPè¯·æ±‚ä¸­è·å–æŸ¥è¯¢å‚æ•°usernameå’Œsessionï¼Œç„¶ååˆ›å»ºä¸€ä¸ªGetUserInfoRequestç»“æ„ä½“å®ä¾‹reqå¹¶å¡«å……å…¶ä¸­çš„å­—æ®µã€‚</p>
<p>â€‹	æ¥ä¸‹æ¥ï¼Œå®ƒåˆ›å»ºä¸€ä¸ªHttpResponseç»“æ„ä½“å®ä¾‹rspç”¨äºè¿”å›å“åº”ã€‚</p>
<p>â€‹	ç„¶åï¼Œå®ƒä½¿ç”¨utilsåŒ…ä¸­çš„Md5Stringå‡½æ•°ç”Ÿæˆä¸€ä¸ªuuidï¼Œå¹¶å°†å…¶ä¿å­˜åœ¨è¯·æ±‚ä¸Šä¸‹æ–‡ctxä¸­ã€‚</p>
<p>â€‹	æœ€åï¼Œå®ƒè°ƒç”¨serviceåŒ…ä¸­çš„GetUserInfoå‡½æ•°æ¥è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶æ ¹æ®è¿”å›ç»“æœä½¿ç”¨HttpResponseç»“æ„ä½“å®ä¾‹rspè¿”å›ç›¸åº”çš„HTTPå“åº”ã€‚</p>
<h5 id="UpdateNickName-æ›´æ–°ç”¨æˆ·æ˜µç§°"><a href="#UpdateNickName-æ›´æ–°ç”¨æˆ·æ˜µç§°" class="headerlink" title="UpdateNickName æ›´æ–°ç”¨æˆ·æ˜µç§°"></a>UpdateNickName æ›´æ–°ç”¨æˆ·æ˜µç§°</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UpdateNickName</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>	req := &amp;service.UpdateNickNameRequest&#123;&#125;<br>	rsp := &amp;HttpResponse&#123;&#125;<br>	err := c.ShouldBindJSON(req)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;bind update user info request json err %v&quot;</span>, err)<br>		rsp.ResponseWithError(c, CodeBodyBindErr, err.Error())<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	session, _ := c.Cookie(constant.SessionKey)<br>	log.Infof(<span class="hljs-string">&quot;UpdateNickName|session=%s&quot;</span>, session)<br>	ctx := context.WithValue(context.Background(), constant.SessionKey, session)<br>	uuid := utils.Md5String(req.UserName + time.Now().GoString())<br>	ctx = context.WithValue(ctx, <span class="hljs-string">&quot;uuid&quot;</span>, uuid)<br>	<span class="hljs-keyword">if</span> err := service.UpdateUserNickName(ctx, req); err != <span class="hljs-literal">nil</span> &#123;<br>		rsp.ResponseWithError(c, CodeUpdateUserInfoErr, err.Error())<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	rsp.ResponseSuccess(c)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	å®ç°äº†ä¸€ä¸ªåä¸º UpdateNickName çš„å‡½æ•°ï¼Œç”¨äºæ›´æ–°ç”¨æˆ·çš„æ˜µç§°ã€‚</p>
<p>â€‹	å‡½æ•°é¦–å…ˆå°è¯•ä» HTTP è¯·æ±‚ä¸­è·å– UpdateNickNameRequest çš„å‚æ•°ï¼Œ</p>
<ul>
<li>â€‹	å¦‚æœè§£æå¤±è´¥åˆ™è¿”å›é”™è¯¯ä¿¡æ¯ã€‚</li>
<li>â€‹	ç„¶åï¼Œå‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªä¸Šä¸‹æ–‡ Context å¯¹è±¡ï¼Œå°†ä¼šè¯ session å’Œ uuid å­˜å‚¨åœ¨å…¶ä¸­ã€‚</li>
<li>æœ€åï¼Œå‡½æ•°è°ƒç”¨äº† service åŒ…ä¸­çš„ UpdateUserNickName å‡½æ•°æ¥æ›´æ–°ç”¨æˆ·æ˜µç§°ã€‚<ul>
<li>å¦‚æœæ›´æ–°å¤±è´¥ï¼Œå‡½æ•°ä¼šè¿”å›é”™è¯¯ä¿¡æ¯ï¼Œ</li>
<li>å¦åˆ™è¿”å›æˆåŠŸçš„å“åº”ã€‚</li>
</ul>
</li>
</ul>
<h5 id="å®Œæ•´ä»£ç -8"><a href="#å®Œæ•´ä»£ç -8" class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> v1<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;context&quot;</span><br>	<span class="hljs-string">&quot;encoding/json&quot;</span><br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	log <span class="hljs-string">&quot;github.com/sirupsen/logrus&quot;</span><br>	<span class="hljs-string">&quot;net/http&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>	<span class="hljs-string">&quot;user_system/config&quot;</span><br>	<span class="hljs-string">&quot;user_system/internal/service&quot;</span><br>	<span class="hljs-string">&quot;user_system/pkg/constant&quot;</span><br>	<span class="hljs-string">&quot;user_system/utils&quot;</span><br>)<br><br><span class="hljs-comment">// Ping å¥åº·æ£€æŸ¥</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Ping</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>	appConfig := config.GetGlobalConf().AppConfig<br>	confInfo, _ := json.MarshalIndent(appConfig, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;  &quot;</span>)<br>	appInfo := fmt.Sprintf(<span class="hljs-string">&quot;app_name: %s\nversion: %s\n\n%s&quot;</span>, appConfig.AppName, appConfig.Version,<br>		<span class="hljs-type">string</span>(confInfo))<br>	c.String(http.StatusOK, appInfo)<br>&#125;<br><br><span class="hljs-comment">// Register æ³¨å†Œ</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Register</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>	req := &amp;service.RegisterRequest&#123;&#125;<br>	rsp := &amp;HttpResponse&#123;&#125;<br>	err := c.ShouldBindJSON(&amp;req)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;request json err %v&quot;</span>, err)<br>		rsp.ResponseWithError(c, CodeBodyBindErr, err.Error())<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-keyword">if</span> err := service.Register(req); err != <span class="hljs-literal">nil</span> &#123;<br>		rsp.ResponseWithError(c, CodeRegisterErr, err.Error())<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	rsp.ResponseSuccess(c)<br>&#125;<br><br><span class="hljs-comment">// Login ç™»å½•</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Login</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>	req := &amp;service.LoginRequest&#123;&#125;<br>	rsp := &amp;HttpResponse&#123;&#125;<br>	err := c.ShouldBindJSON(&amp;req)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;request json err %v&quot;</span>, err)<br>		rsp.ResponseWithError(c, CodeBodyBindErr, err.Error())<br>		<span class="hljs-keyword">return</span><br>	&#125;<br><br>	uuid := utils.Md5String(req.UserName + time.Now().GoString())<br>	ctx := context.WithValue(context.Background(), <span class="hljs-string">&quot;uuid&quot;</span>, uuid)<br>	log.Infof(<span class="hljs-string">&quot;loggin start,user:%s, password:%s&quot;</span>, req.UserName, req.PassWord)<br>	session, err := service.Login(ctx, req)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		rsp.ResponseWithError(c, CodeLoginErr, err.Error())<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	<span class="hljs-comment">// ç™»é™†æˆåŠŸï¼Œè®¾ç½®cookie</span><br>	c.SetCookie(constant.SessionKey, session, constant.CookieExpire, <span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>)<br>	rsp.ResponseSuccess(c)<br>&#125;<br><br><span class="hljs-comment">// Logout ç™»å‡º</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Logout</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>	session, _ := c.Cookie(constant.SessionKey)<br>	ctx := context.WithValue(context.Background(), constant.SessionKey, session)<br>	req := &amp;service.LogoutRequest&#123;&#125;<br>	rsp := &amp;HttpResponse&#123;&#125;<br>	err := c.ShouldBindJSON(req)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;bind get logout request json err %v&quot;</span>, err)<br>		rsp.ResponseWithError(c, CodeBodyBindErr, err.Error())<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	uuid := utils.Md5String(req.UserName + time.Now().GoString())<br>	ctx = context.WithValue(ctx, <span class="hljs-string">&quot;uuid&quot;</span>, uuid)<br>	<span class="hljs-keyword">if</span> err := service.Logout(ctx, req); err != <span class="hljs-literal">nil</span> &#123;<br>		rsp.ResponseWithError(c, CodeLogoutErr, err.Error())<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	c.SetCookie(constant.SessionKey, session, <span class="hljs-number">-1</span>, <span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>)<br>	rsp.ResponseSuccess(c)<br>&#125;<br><br><span class="hljs-comment">// GetUserInfo è·å–ç”¨æˆ·ä¿¡æ¯</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetUserInfo</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>	userName := c.Query(<span class="hljs-string">&quot;username&quot;</span>)<br>	session, _ := c.Cookie(constant.SessionKey)<br>	ctx := context.WithValue(context.Background(), constant.SessionKey, session)<br>	req := &amp;service.GetUserInfoRequest&#123;<br>		UserName: userName,<br>	&#125;<br>	rsp := &amp;HttpResponse&#123;&#125;<br>	uuid := utils.Md5String(req.UserName + time.Now().GoString())<br>	ctx = context.WithValue(ctx, <span class="hljs-string">&quot;uuid&quot;</span>, uuid)<br>	userInfo, err := service.GetUserInfo(ctx, req)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		rsp.ResponseWithError(c, CodeGetUserInfoErr, err.Error())<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	rsp.ResponseWithData(c, userInfo)<br>&#125;<br><br><span class="hljs-comment">// UpdateNickName æ›´æ–°ç”¨æˆ·æ˜µç§°</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">UpdateNickName</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>	req := &amp;service.UpdateNickNameRequest&#123;&#125;<br>	rsp := &amp;HttpResponse&#123;&#125;<br>	err := c.ShouldBindJSON(req)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Errorf(<span class="hljs-string">&quot;bind update user info request json err %v&quot;</span>, err)<br>		rsp.ResponseWithError(c, CodeBodyBindErr, err.Error())<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	session, _ := c.Cookie(constant.SessionKey)<br>	log.Infof(<span class="hljs-string">&quot;UpdateNickName|session=%s&quot;</span>, session)<br>	ctx := context.WithValue(context.Background(), constant.SessionKey, session)<br>	uuid := utils.Md5String(req.UserName + time.Now().GoString())<br>	ctx = context.WithValue(ctx, <span class="hljs-string">&quot;uuid&quot;</span>, uuid)<br>	<span class="hljs-keyword">if</span> err := service.UpdateUserNickName(ctx, req); err != <span class="hljs-literal">nil</span> &#123;<br>		rsp.ResponseWithError(c, CodeUpdateUserInfoErr, err.Error())<br>		<span class="hljs-keyword">return</span><br>	&#125;<br>	rsp.ResponseSuccess(c)<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="â‘¡-entity-go"><a href="#â‘¡-entity-go" class="headerlink" title="â‘¡ entity.go"></a>â‘¡ entity.go</h4><h5 id="å®šä¹‰é”™è¯¯ç "><a href="#å®šä¹‰é”™è¯¯ç " class="headerlink" title="å®šä¹‰é”™è¯¯ç "></a>å®šä¹‰é”™è¯¯ç </h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> (<br>	CodeSuccess           ErrCode = <span class="hljs-number">0</span>     <span class="hljs-comment">// httpè¯·æ±‚æˆåŠŸ</span><br>	CodeBodyBindErr       ErrCode = <span class="hljs-number">10001</span> <span class="hljs-comment">// å‚æ•°ç»‘å®šé”™è¯¯</span><br>	CodeParamErr          ErrCode = <span class="hljs-number">10002</span> <span class="hljs-comment">// è¯·æ±‚å‚æ•°ä¸åˆæ³•</span><br>	CodeRegisterErr       ErrCode = <span class="hljs-number">10003</span> <span class="hljs-comment">// æ³¨å†Œé”™è¯¯</span><br>	CodeLoginErr          ErrCode = <span class="hljs-number">10003</span> <span class="hljs-comment">// ç™»å½•é”™è¯¯</span><br>	CodeLogoutErr         ErrCode = <span class="hljs-number">10004</span> <span class="hljs-comment">// ç™»å‡ºé”™è¯¯</span><br>	CodeGetUserInfoErr    ErrCode = <span class="hljs-number">10005</span> <span class="hljs-comment">// è·å–ç”¨æˆ·ä¿¡æ¯é”™è¯¯</span><br>	CodeUpdateUserInfoErr ErrCode = <span class="hljs-number">10006</span> <span class="hljs-comment">// æ›´æ–°ç”¨æˆ·ä¿¡æ¯é”™è¯¯</span><br>)<br></code></pre></td></tr></table></figure>

<ul>
<li>CodeSuccessï¼šè¡¨ç¤ºè¯·æ±‚æˆåŠŸï¼Œé”™è¯¯ç ä¸º0ã€‚</li>
<li>CodeBodyBindErrï¼šè¡¨ç¤ºè¯·æ±‚å‚æ•°ç»‘å®šé”™è¯¯ï¼Œé”™è¯¯ç ä¸º10001ã€‚</li>
<li>CodeParamErrï¼šè¡¨ç¤ºè¯·æ±‚å‚æ•°ä¸åˆæ³•ï¼Œé”™è¯¯ç ä¸º10002ã€‚</li>
<li>CodeRegisterErrï¼šè¡¨ç¤ºæ³¨å†Œé”™è¯¯ï¼Œé”™è¯¯ç ä¸º10003ã€‚</li>
<li>CodeLoginErrï¼šè¡¨ç¤ºç™»å½•é”™è¯¯ï¼Œé”™è¯¯ç ä¸º10003ã€‚æ³¨æ„è¿™ä¸ªé”™è¯¯ç ä¸ä¸Šé¢çš„CodeRegisterErræ˜¯ä¸€æ ·çš„ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªé”™è¯¯ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œè°ƒæ•´ã€‚</li>
<li>CodeLogoutErrï¼šè¡¨ç¤ºç™»å‡ºé”™è¯¯ï¼Œé”™è¯¯ç ä¸º10004ã€‚</li>
<li>CodeGetUserInfoErrï¼šè¡¨ç¤ºè·å–ç”¨æˆ·ä¿¡æ¯é”™è¯¯ï¼Œé”™è¯¯ç ä¸º10005ã€‚</li>
<li>CodeUpdateUserInfoErrï¼šè¡¨ç¤ºæ›´æ–°ç”¨æˆ·ä¿¡æ¯é”™è¯¯ï¼Œé”™è¯¯ç ä¸º10006ã€‚</li>
</ul>
<h5 id="å®šä¹‰åˆ«å"><a href="#å®šä¹‰åˆ«å" class="headerlink" title="å®šä¹‰åˆ«å"></a>å®šä¹‰åˆ«å</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> (<br>	DebugType <span class="hljs-type">int</span> <span class="hljs-comment">// debugç±»å‹</span><br>	ErrCode   <span class="hljs-type">int</span> <span class="hljs-comment">// é”™è¯¯ç </span><br>)<br></code></pre></td></tr></table></figure>

<p>â€‹	å…¶ä¸­<code>DebugType</code>å’Œ<code>ErrCode</code>åˆ†åˆ«æ˜¯<code>int</code>ç±»å‹çš„åˆ«åã€‚è¿™æ ·å®šä¹‰åˆ«åå¯ä»¥æ–¹ä¾¿ä»£ç çš„é˜…è¯»å’Œç»´æŠ¤ï¼Œæ¯”å¦‚åœ¨ä¸åŒçš„åœºæ™¯ä¸­ï¼Œå¯ä»¥ç”¨<code>ErrCode</code>æ¥ä»£è¡¨ä¸åŒçš„é”™è¯¯ç ï¼Œè€Œä¸æ˜¯ç”¨ä¸€ä¸ªçº¯æ•°å­—ï¼Œä»è€Œæé«˜ä»£ç çš„å¯è¯»æ€§ã€‚</p>
<h5 id="HttpResponse-httpç‹¬ç«‹è¯·æ±‚è¿”å›ç»“æ„ä½“"><a href="#HttpResponse-httpç‹¬ç«‹è¯·æ±‚è¿”å›ç»“æ„ä½“" class="headerlink" title="HttpResponse httpç‹¬ç«‹è¯·æ±‚è¿”å›ç»“æ„ä½“"></a>HttpResponse httpç‹¬ç«‹è¯·æ±‚è¿”å›ç»“æ„ä½“</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> HttpResponse <span class="hljs-keyword">struct</span> &#123;<br>	Code ErrCode     <span class="hljs-string">`json:&quot;code&quot;`</span><br>	Msg  <span class="hljs-type">string</span>      <span class="hljs-string">`json:&quot;msg&quot;`</span><br>	Data <span class="hljs-keyword">interface</span>&#123;&#125; <span class="hljs-string">`json:&quot;data&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>HttpResponse</code> æ˜¯ä¸€ä¸ªé€šç”¨çš„ HTTP å“åº”ç»“æ„ä½“ï¼Œç”¨äºè¿”å›ç»™å®¢æˆ·ç«¯çš„æ•°æ®ã€‚å®ƒåŒ…å«ä»¥ä¸‹ä¸‰ä¸ªå­—æ®µï¼š</p>
<ul>
<li><code>Code</code> æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„é”™è¯¯ç ï¼Œç”¨äºè¡¨ç¤ºå½“å‰ HTTP è¯·æ±‚çš„å¤„ç†ç»“æœã€‚</li>
<li><code>Msg</code> æ˜¯ä¸€ä¸ªå¯è¯»æ€§æ›´å¥½çš„é”™è¯¯ä¿¡æ¯ï¼Œç”¨äºè¯´æ˜ <code>Code</code> æ‰€ä»£è¡¨çš„å«ä¹‰ã€‚</li>
<li><code>Data</code> æ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ï¼Œç”¨äºå­˜å‚¨è¿”å›ç»™å®¢æˆ·ç«¯çš„æ•°æ®ï¼Œç±»å‹ä¸å›ºå®šï¼Œå¯ä»¥æ˜¯ä»»ä½•ç±»å‹çš„æ•°æ®ã€‚</li>
</ul>
<p>â€‹	é€šè¿‡è¿™æ ·ä¸€ä¸ªé€šç”¨çš„å“åº”ç»“æ„ä½“ï¼Œå¯ä»¥æ–¹ä¾¿åœ°å¤„ç†å„ç§ HTTP è¯·æ±‚ï¼Œå¹¶å°†å¤„ç†ç»“æœç»Ÿä¸€å°è£…ä¸º JSON æ ¼å¼çš„æ•°æ®ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ã€‚è¿™æ ·å®¢æˆ·ç«¯åªéœ€è¦æ ¹æ®å“åº”ç»“æ„ä½“ä¸­çš„ <code>Code</code> å’Œ <code>Msg</code> å­—æ®µæ¥åˆ¤æ–­è¯·æ±‚å¤„ç†æ˜¯å¦æˆåŠŸï¼Œç„¶åæ ¹æ®éœ€è¦æ¥å¤„ç† <code>Data</code> å­—æ®µä¸­çš„å…·ä½“æ•°æ®å³å¯ã€‚</p>
<h5 id="ResponseWithError-httpè¯·æ±‚è¿”å›å¤„ç†å‡½æ•°"><a href="#ResponseWithError-httpè¯·æ±‚è¿”å›å¤„ç†å‡½æ•°" class="headerlink" title="ResponseWithError httpè¯·æ±‚è¿”å›å¤„ç†å‡½æ•°"></a>ResponseWithError httpè¯·æ±‚è¿”å›å¤„ç†å‡½æ•°</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rsp *HttpResponse)</span></span> ResponseWithError(c *gin.Context, code ErrCode, msg <span class="hljs-type">string</span>) &#123;<br>	rsp.Code = code<br>	rsp.Msg = msg<br>	c.JSON(http.StatusInternalServerError, rsp)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¿™ä¸ªå‡½æ•°æ˜¯ <code>HttpResponse</code> ç»“æ„ä½“çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºè¿”å›ä¸€ä¸ªå¸¦æœ‰é”™è¯¯ä¿¡æ¯çš„ HTTP å“åº”ã€‚å®ƒä¼šè®¾ç½® <code>rsp</code> çš„ <code>Code</code> å’Œ <code>Msg</code> å­—æ®µï¼Œç„¶åè°ƒç”¨ Gin æ¡†æ¶çš„ <code>JSON</code> æ–¹æ³•è¿”å›ä¸€ä¸ª HTTP çŠ¶æ€ç ä¸º 500 çš„å“åº”ï¼Œå“åº”å†…å®¹å°±æ˜¯ <code>rsp</code> ç»“æ„ä½“åºåˆ—åŒ–åçš„ JSON æ•°æ®ã€‚</p>
<h5 id="ResponseSuccessæ“ä½œæˆåŠŸå“åº”"><a href="#ResponseSuccessæ“ä½œæˆåŠŸå“åº”" class="headerlink" title="ResponseSuccess	æ“ä½œæˆåŠŸå“åº”"></a>ResponseSuccess	æ“ä½œæˆåŠŸå“åº”</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rsp *HttpResponse)</span></span> ResponseSuccess(c *gin.Context) &#123;<br>	rsp.Code = CodeSuccess<br>	rsp.Msg = <span class="hljs-string">&quot;success&quot;</span><br>	c.JSON(http.StatusOK, rsp)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥è¿”å›æ“ä½œæˆåŠŸçš„å“åº”ã€‚å®ƒå°†å“åº”ç»“æ„ä½“ä¸­çš„Codeå­—æ®µè®¾ç½®ä¸ºCodeSuccessï¼Œå°†Msgå­—æ®µè®¾ç½®ä¸ºâ€successâ€ï¼Œç„¶åå°†æ•´ä¸ªç»“æ„ä½“ä»¥JSONæ ¼å¼è¿”å›ç»™å®¢æˆ·ç«¯ã€‚å“åº”çŠ¶æ€ç æ˜¯200ï¼Œè¡¨ç¤ºè¯·æ±‚æˆåŠŸã€‚</p>
<h5 id="ResponseWithDataå¸¦æœ‰æ•°æ®çš„æˆåŠŸå“åº”"><a href="#ResponseWithDataå¸¦æœ‰æ•°æ®çš„æˆåŠŸå“åº”" class="headerlink" title="ResponseWithData	å¸¦æœ‰æ•°æ®çš„æˆåŠŸå“åº”"></a>ResponseWithData	å¸¦æœ‰æ•°æ®çš„æˆåŠŸå“åº”</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rsp *HttpResponse)</span></span> ResponseWithData(c *gin.Context, data <span class="hljs-keyword">interface</span>&#123;&#125;) &#123;<br>	rsp.Code = CodeSuccess<br>	rsp.Msg = <span class="hljs-string">&quot;success&quot;</span><br>	rsp.Data = data<br>	c.JSON(http.StatusOK, rsp)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>â€‹	è¿™ä¸ªæ–¹æ³•ç”¨äºè¿”å›å¸¦æœ‰æ•°æ®çš„æˆåŠŸå“åº”ï¼Œä¼šè®¾ç½® <code>rsp</code> ç»“æ„ä½“ä¸­çš„ <code>Code</code> å­—æ®µä¸º <code>CodeSuccess</code>ï¼Œ<code>Msg</code> å­—æ®µä¸º â€œsuccessâ€ï¼Œ<code>Data</code> å­—æ®µä¸ºä¼ å…¥çš„ <code>data</code> å‚æ•°ã€‚</p>
<p>â€‹	ç„¶åè°ƒç”¨ Gin çš„ <code>JSON</code> æ–¹æ³•å°† <code>rsp</code> ç»“æ„ä½“åºåˆ—åŒ–ä¸º JSON æ ¼å¼çš„å“åº”å¹¶å‘é€ç»™å®¢æˆ·ç«¯ï¼ŒHTTP çŠ¶æ€ç ä¸º <code>http.StatusOK</code>ã€‚</p>
<h5 id="å®Œæ•´ä»£ç -9"><a href="#å®Œæ•´ä»£ç -9" class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> v1<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br>	<span class="hljs-string">&quot;net/http&quot;</span><br>)<br><br><span class="hljs-keyword">const</span> (<br>	CodeSuccess           ErrCode = <span class="hljs-number">0</span>     <span class="hljs-comment">// httpè¯·æ±‚æˆåŠŸ</span><br>	CodeBodyBindErr       ErrCode = <span class="hljs-number">10001</span> <span class="hljs-comment">// å‚æ•°ç»‘å®šé”™è¯¯</span><br>	CodeParamErr          ErrCode = <span class="hljs-number">10002</span> <span class="hljs-comment">// è¯·æ±‚å‚æ•°ä¸åˆæ³•</span><br>	CodeRegisterErr       ErrCode = <span class="hljs-number">10003</span> <span class="hljs-comment">// æ³¨å†Œé”™è¯¯</span><br>	CodeLoginErr          ErrCode = <span class="hljs-number">10003</span> <span class="hljs-comment">// ç™»å½•é”™è¯¯</span><br>	CodeLogoutErr         ErrCode = <span class="hljs-number">10004</span> <span class="hljs-comment">// ç™»å‡ºé”™è¯¯</span><br>	CodeGetUserInfoErr    ErrCode = <span class="hljs-number">10005</span> <span class="hljs-comment">// è·å–ç”¨æˆ·ä¿¡æ¯é”™è¯¯</span><br>	CodeUpdateUserInfoErr ErrCode = <span class="hljs-number">10006</span> <span class="hljs-comment">// æ›´æ–°ç”¨æˆ·ä¿¡æ¯é”™è¯¯</span><br>)<br><br><span class="hljs-keyword">type</span> (<br>	DebugType <span class="hljs-type">int</span> <span class="hljs-comment">// debugç±»å‹</span><br>	ErrCode   <span class="hljs-type">int</span> <span class="hljs-comment">// é”™è¯¯ç </span><br>)<br><br><span class="hljs-comment">// HttpResponse httpç‹¬ç«‹è¯·æ±‚è¿”å›ç»“æ„ä½“</span><br><span class="hljs-keyword">type</span> HttpResponse <span class="hljs-keyword">struct</span> &#123;<br>	Code ErrCode     <span class="hljs-string">`json:&quot;code&quot;`</span><br>	Msg  <span class="hljs-type">string</span>      <span class="hljs-string">`json:&quot;msg&quot;`</span><br>	Data <span class="hljs-keyword">interface</span>&#123;&#125; <span class="hljs-string">`json:&quot;data&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// ResponseWithError httpè¯·æ±‚è¿”å›å¤„ç†å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rsp *HttpResponse)</span></span> ResponseWithError(c *gin.Context, code ErrCode, msg <span class="hljs-type">string</span>) &#123;<br>	rsp.Code = code<br>	rsp.Msg = msg<br>	c.JSON(http.StatusInternalServerError, rsp)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rsp *HttpResponse)</span></span> ResponseSuccess(c *gin.Context) &#123;<br>	rsp.Code = CodeSuccess<br>	rsp.Msg = <span class="hljs-string">&quot;success&quot;</span><br>	c.JSON(http.StatusOK, rsp)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rsp *HttpResponse)</span></span> ResponseWithData(c *gin.Context, data <span class="hljs-keyword">interface</span>&#123;&#125;) &#123;<br>	rsp.Code = CodeSuccess<br>	rsp.Msg = <span class="hljs-string">&quot;success&quot;</span><br>	rsp.Data = data<br>	c.JSON(http.StatusOK, rsp)<br>&#125;<br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Go/" class="category-chain-item">Go</a>
  
  
    <span>></span>
    
  <a href="/categories/Go/%E9%A1%B9%E7%9B%AE/" class="category-chain-item">é¡¹ç›®</a>
  
  
    <span>></span>
    
  <a href="/categories/Go/%E9%A1%B9%E7%9B%AE/user-system/" class="category-chain-item">user_system</a>
  
  

  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/GO/">#GO</a>
      
        <a href="/tags/%E9%A1%B9%E7%9B%AE/">#é¡¹ç›®</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>user_systemé¡¹ç›®</div>
      <div>http://example.com/2023/04/18/Goé¡¹ç›®/user-systemé¡¹ç›®/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>ä½œè€…</div>
          <div>Feng Tao</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>å‘å¸ƒäº</div>
          <div>2023å¹´4æœˆ18æ—¥</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>æ›´æ–°äº</div>
          <div>2023å¹´4æœˆ21æ—¥</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>è®¸å¯åè®®</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - ç½²å">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/04/18/Go%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98/%E4%BD%A0%E4%BA%86%E8%A7%A3defer%E5%90%97%EF%BC%9F/" title="ä½ äº†è§£deferå—ï¼Ÿ">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ä½ äº†è§£deferå—ï¼Ÿ</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/04/17/%E5%88%B7%E9%A2%98/%E6%9C%80%E5%A4%A7%E4%B8%8A%E5%8D%87%E5%AD%90%E5%BA%8F%E5%88%97%E5%92%8C/" title="æœ€å¤§ä¸Šå‡å­åºåˆ—å’Œ">
                        <span class="hidden-mobile">æœ€å¤§ä¸Šå‡å­åºåˆ—å’Œ</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"n0H6ZjcwsAdPc2zfOJM4bxV4-gzGzoHsz","appKey":"rwjeQIHfYJqQvjh2iWuPkYev","path":"window.location.pathname","placeholder":"åŒ¿åè¯„è®ºï¼Œç•…æ‰€æ¬²è¨€","avatar":"robohash","meta":["nick","mail"],"requiredFields":[],"pageSize":20,"lang":"zh-CN","highlight":true,"recordIP":true,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":true},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  








    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div style="font-size: 0.85rem"> <span id="timeDate">è½½å…¥å¤©æ•°...</span> <span id="times">è½½å…¥æ—¶åˆ†ç§’...</span> <script src="/js/duration.js"></script> </div> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="leancloud-site-pv"></span>
         æ¬¡
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="leancloud-site-uv"></span>
         äºº
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>

<!-- é¡µé¢ç‚¹å‡»å°çº¢å¿ƒ -->
<script type="text/javascript" src="/js/love.js"></script>

<!--åŠ¨æ€çº¿æ¡èƒŒæ™¯-->
<script type="text/javascript"
color="220,220,220" opacity='0.7' zIndex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js">
</script>

<!-- é›ªèŠ±ç‰¹æ•ˆ -->
<script type="text/javascript" src="\js\snow.js"></script>